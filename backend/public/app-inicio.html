<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In√≠cio - Tem de Tudo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0a0a0f; color: #fff; padding-bottom: 80px; overflow-x: hidden; }
        
        .header { padding: 20px 20px 16px; background: #0a0a0f; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .greeting { font-size: 20px; font-weight: 400; margin-bottom: 4px; color: #aaa; }
        .user-name { font-size: 26px; font-weight: 900; color: #fff; }
        .profile-type { font-size: 13px; color: #f39c12; margin-top: 4px; display: flex; align-items: center; gap: 6px; }
        .saldo-badge { background: #f59e0b; padding: 12px 18px; border-radius: 24px; border: 2px solid rgba(255, 215, 0, 0.4); cursor: pointer; }
        .saldo-label { font-size: 11px; opacity: 0.9; }
        .saldo-value { font-size: 18px; font-weight: 800; }
        
        .search-container { padding: 0 20px 16px; }
        .search-box { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(102, 126, 234, 0.2); }
        .search-box i { color: #667eea; font-size: 18px; }
        .search-box input { flex: 1; background: none; border: none; color: #fff; font-size: 15px; outline: none; }
        .search-box input::placeholder { color: #888; }
        
        .location { padding: 0 20px 16px; display: flex; align-items: center; gap: 8px; color: #888; font-size: 13px; }
        .location i { color: #667eea; }
        .location span { flex: 1; }
        
        .section { padding: 0 20px 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 18px; font-weight: 800; }
        .ver-mais { font-size: 13px; color: #667eea; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 4px; }
        
        .categories-scroll { display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
        .categories-scroll::-webkit-scrollbar { display: none; }
        .category-card { min-width: 100px; text-align: center; text-decoration: none; color: #fff; }
        .category-icon { width: 80px; height: 80px; background: rgba(255,255,255,0.05); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 8px; transition: all 0.3s; }
        .category-card:active .category-icon { transform: scale(0.95); background: linear-gradient(135deg, #667eea20, #764ba220); }
        .category-name { font-size: 12px; font-weight: 600; }
        
        .banner-carousel { margin: 0 20px 24px; overflow: hidden; border-radius: 16px; }
        .banner-img { width: 100%; height: 160px; object-fit: cover; border-radius: 16px; }
        
        .empresas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .empresa-card { background: rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; text-decoration: none; color: #fff; border: 1px solid rgba(102, 126, 234, 0.1); transition: transform 0.3s; }
        .empresa-card:active { transform: scale(0.97); }
        .empresa-img { width: 100%; height: 120px; object-fit: cover; }
        .empresa-content { padding: 12px; }
        .empresa-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .empresa-category { font-size: 11px; color: #888; margin-bottom: 8px; }
        .empresa-footer { display: flex; justify-content: space-between; align-items: center; }
        .empresa-distance { font-size: 11px; color: #667eea; display: flex; align-items: center; gap: 4px; }
        .empresa-pontos { background: linear-gradient(135deg, #f39c12, #e67e22); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0f; border-top: 1px solid rgba(102, 126, 234, 0.1); display: flex; justify-content: space-around; padding: 12px 0 8px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: #888; font-size: 11px; font-weight: 500; }
        .nav-item.active { color: #667eea; }
        .nav-item i { font-size: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div>
                <div class="greeting">Ol√°, <span id="userName">...</span></div>
                <div class="profile-type" id="profileType">
                    <i class="fas fa-spinner fa-spin"></i> Carregando...
                </div>
            </div>
            <div class="saldo-badge" onclick="location.href='/app-meus-pontos.html'">
                <div>
                    <div class="saldo-label">Saldo:</div>
                    <div class="saldo-value">$ <span id="saldoValue">0,00</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="O que est√° procurando?" id="searchInput">
        </div>
    </div>

    <div class="location">
        <i class="fas fa-map-marker-alt"></i>
        <span>Visualizando ofertas em: S√£o Paulo, SP</span>
        <i class="fas fa-chevron-down"></i>
    </div>

    <div class="section">
        <div class="section-header">
            <div class="section-title">Categorias</div>
            <a href="/app-categorias.html" class="ver-mais">Ver Mais <i class="fas fa-chevron-right"></i></a>
        </div>
        <div class="categories-scroll">
            <a href="/app-empresas.html?category=alimentacao" class="category-card">
                <div class="category-icon">üçî</div>
                <div class="category-name">Alimentos</div>
            </a>
            <a href="/app-empresas.html?category=automotivo" class="category-card">
                <div class="category-icon">üöó</div>
                <div class="category-name">Automotivo</div>
            </a>
            <a href="/app-empresas.html?category=beleza" class="category-card">
                <div class="category-icon">üíÑ</div>
                <div class="category-name">Beleza</div>
            </a>
            <a href="/app-empresas.html?category=saude" class="category-card">
                <div class="category-icon">üíä</div>
                <div class="category-name">Sa√∫de</div>
            </a>
            <a href="/app-empresas.html?category=servicos" class="category-card">
                <div class="category-icon">üîß</div>
                <div class="category-name">Servi√ßos</div>
            </a>
        </div>
    </div>

    <div class="banner-carousel">
        <img src="https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800" alt="Banner" class="banner-img">
    </div>

    <div class="section">
        <div class="section-header">
            <div class="section-title">Perto de voc√™</div>
            <a href="/app-empresas.html" class="ver-mais">Ver todos <i class="fas fa-chevron-right"></i></a>
        </div>
        <div class="empresas-grid" id="empresasGrid">
            <!-- Carregando empresas... -->
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="/app-inicio.html" class="nav-item active"><i class="fas fa-home"></i><span>In√≠cio</span></a>
        <a href="/app-empresas.html" class="nav-item"><i class="fas fa-search"></i><span>Buscar</span></a>
        <a href="/app-meus-pontos.html" class="nav-item"><i class="fas fa-wallet"></i><span>Pontos</span></a>
        <a href="/app-promocoes.html" class="nav-item"><i class="fas fa-tags"></i><span>Promo√ß√µes</span></a>
        <a href="/app-perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
    </nav>

    <script>
        // Fun√ß√£o para verificar autentica√ß√£o
        function checkAuth() {
            const token = localStorage.getItem('token'); // CORRIGIDO: usar 'token' em vez de 'auth_token'
            if (!token) {
                window.location.href = '/entrar.html';
                return false;
            }
            return token;
        }

        // Fun√ß√£o para fazer requisi√ß√µes autenticadas
        async function apiRequest(url, options = {}) {
            const token = localStorage.getItem('token'); // CORRIGIDO: usar 'token'
            
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(url, {
                ...options,
                headers: { ...headers, ...(options.headers || {}) }
            });
            
            if (response.status === 401) {
                localStorage.removeItem('token'); // CORRIGIDO
                localStorage.removeItem('user_data');
                window.location.href = '/entrar.html';
                return null;
            }
            
            return response;
        }

        // Carregar dados do usu√°rio
        async function loadUserData() {
            try {
                const token = checkAuth();
                if (!token) return;

                // Primeiro tenta buscar dados da API
                const response = await apiRequest('/api/auth/me');
                
                if (response && response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.user) {
                        // Atualizar UI com dados reais
                        document.getElementById('userName').textContent = data.user.name || data.user.nome || 'Usu√°rio';
                        document.getElementById('saldoValue').textContent = (data.user.pontos || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                        
                        // Atualizar perfil din√¢mico
                        updateProfileType(data.user);
                        
                        // Salvar no localStorage para cache
                        localStorage.setItem('user_data', JSON.stringify(data.user));
                    } else {
                        throw new Error('Dados do usu√°rio inv√°lidos');
                    }
                } else {
                    throw new Error('Erro na API');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio:', error);
                
                // Fallback: usar dados do cache se existir
                const cachedUser = localStorage.getItem('user');
                if (cachedUser) {
                    try {
                        const user = JSON.parse(cachedUser);
                        document.getElementById('userName').textContent = user.name || user.nome || 'Usu√°rio';
                        document.getElementById('saldoValue').textContent = (user.pontos || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                        updateProfileType(user);
                    } catch {
                        // Se cache inv√°lido, usar dados padr√£o
                        setDefaultUserData();
                    }
                } else {
                    setDefaultUserData();
                }
            }
        }

        // Atualizar tipo de perfil dinamicamente
        function updateProfileType(user) {
            const profileTypeElement = document.getElementById('profileType');
            const userType = user.perfil || user.tipo || user.user_type || 'cliente';
            
            let profileText = '';
            let iconClass = '';
            
            switch(userType) {
                case 'cliente':
                    profileText = `Plano Cliente`;
                    iconClass = 'fas fa-user';
                    break;
                case 'empresa':
                    profileText = `Plano Empresa`;
                    iconClass = 'fas fa-building';
                    break;
                case 'admin':
                    profileText = `Administrador`;
                    iconClass = 'fas fa-crown';
                    break;
                default:
                    profileText = `Plano ${userType.charAt(0).toUpperCase() + userType.slice(1)}`;
                    iconClass = 'fas fa-user-circle';
            }
            
            profileTypeElement.innerHTML = `<i class="${iconClass}"></i> ${profileText}`;
        }

        // Definir dados padr√£o
        function setDefaultUserData() {
            document.getElementById('userName').textContent = 'Usu√°rio';
            document.getElementById('saldoValue').textContent = '0,00';
            document.getElementById('profileType').innerHTML = '<i class="fas fa-user-circle"></i> Carregando...';
        }

        // Carregar empresas pr√≥ximas
        async function loadEmpresas() {
            try {
                const response = await apiRequest('/api/empresas?limit=6');
                
                if (response && response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.empresas) {
                        renderEmpresas(data.empresas);
                        return;
                    }
                }
                
                // Se falhar, usar empresas mockadas como fallback
                loadEmpresasFallback();
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                loadEmpresasFallback();
            }
        }

        // Fallback com empresas mockadas
        function loadEmpresasFallback() {
            const empresasMock = [
                {id: 1, nome: 'Sabor e Arte', descricao: 'Restaurante brasileiro', logo: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400', points_multiplier: 1.5},
                {id: 2, nome: 'Bella Napoli', descricao: 'Pizzaria artesanal', logo: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400', points_multiplier: 2},
                {id: 3, nome: 'FitLife Academia', descricao: 'Academia completa', logo: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=400', points_multiplier: 1},
                {id: 4, nome: 'Beleza Total', descricao: 'Sal√£o de beleza', logo: 'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=400', points_multiplier: 1.2},
                {id: 5, nome: 'Caf√© & Cia', descricao: 'Cafeteria', logo: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400', points_multiplier: 1.5},
                {id: 6, nome: 'Pet Shop Amigo Fiel', descricao: 'Pet Shop', logo: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=400', points_multiplier: 1}
            ];
            renderEmpresas(empresasMock);
        }

        // Renderizar empresas na UI
        function renderEmpresas(empresas) {
            const grid = document.getElementById('empresasGrid');
            grid.innerHTML = empresas.map(e => `
                <a href="/app-empresa-detalhes.html?id=${e.id}" class="empresa-card">
                    <img src="${e.logo || 'https://via.placeholder.com/400x300?text=Sem+Logo'}" 
                         alt="${e.nome}" 
                         class="empresa-img" 
                         onerror="this.src='https://via.placeholder.com/400x300?text=Sem+Logo'">
                    <div class="empresa-content">
                        <div class="empresa-name">${e.nome}</div>
                        <div class="empresa-category">${e.descricao || e.categoria || 'Estabelecimento'}</div>
                        <div class="empresa-footer">
                            <div class="empresa-distance">
                                <i class="fas fa-map-marker-alt"></i> ${Math.floor(Math.random() * 5) + 1} km
                            </div>
                            <div class="empresa-pontos">
                                ${e.points_multiplier || 1}x pontos
                            </div>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        // Busca
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim();
                if (query) {
                    window.location.href = `/app-empresas.html?q=${encodeURIComponent(query)}`;
                }
            }
        });

        // Inicializa√ß√£o quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            loadEmpresas();
        });
    </script>
</body>
</html>


