<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#6F1AB6">
<title>Cartões Fidelidade - Tem de Tudo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="/js/config.js"></script>
<link rel="stylesheet" href="/css/style-unificado.css?v=3">
</head>
<body>
<div class="header">
<div class="header-content">
<button class="back-btn" onclick="history.back()">
<i class="fas fa-arrow-left"></i>
</button>
<div class="header-title">
<h1>Cartões Fidelidade</h1>
<p id="totalCartoes">Carregando...</p>
</div>
</div>
</div>
<div class="cartoes-list" id="cartoesList">
<div class="empty-state">
<i class="fas fa-spinner fa-spin"></i>
<p>Carregando cartões...</p>
</div>
</div>
<nav class="bottom-nav">
<a href="app-inicio-vivo.html" class="nav-item">
<i class="fas fa-home"></i>
<span>Início</span>
</a>
<a href="app-buscar-vivo.html" class="nav-item">
<i class="fas fa-search"></i>
<span>Buscar</span>
</a>
<a href="app-scanner-vivo.html" class="nav-item">
<i class="fas fa-qrcode"></i>
<span>QR Code</span>
</a>
<a href="app-perfil-novo.html" class="nav-item">
<i class="fas fa-user"></i>
<span>Perfil</span>
</a>
</nav>
<script>
        async function loadCartoes() {
            try {
                const token = localStorage.getItem('token');
                const baseURL = API_CONFIG.getBaseURL();
                
                const response = await fetch(`${baseURL}/api/cliente/cartoes-fidelidade`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const cartoes = result.data || result.cartoes || result || [];
                    renderCartoes(cartoes);
                } else {
                    renderEmpty();
                }
            } catch (error) {
                console.error('Erro ao carregar cartões:', error);
                renderEmpty();
            }
        }
        
        function renderCartoes(cartoes) {
            const list = document.getElementById('cartoesList');
            const total = document.getElementById('totalCartoes');
            
            total.textContent = `${cartoes.length} cartões ativos`;
            
            if (cartoes.length === 0) {
                renderEmpty();
                return;
            }
            
            list.innerHTML = cartoes.map(cartao => {
                const progresso = Math.min(100, (cartao.carimbos_atuais / cartao.carimbos_necessarios) * 100);
                const completo = cartao.carimbos_atuais >= cartao.carimbos_necessarios;
                
                let carimbosHtml = '';
                for (let i = 0; i < cartao.carimbos_necessarios; i++) {
                    const preenchido = i < cartao.carimbos_atuais;
                    carimbosHtml += `<div class="carimbo ${preenchido ? 'preenchido' : ''}">${preenchido ? '✓' : ''}</div>`;
                }
                
                return `
                    <div class="cartao-card">
<div class="cartao-header">
<div class="cartao-empresa">${cartao.empresa_nome || 'Estabelecimento'}</div>
<div class="cartao-nome">${cartao.nome}</div>
<div class="progress-container">
<div class="progress-bar" style="width: ${progresso}%"></div>
</div>
<div class="progress-text">${cartao.carimbos_atuais} de ${cartao.carimbos_necessarios} carimbos</div>
</div>
<div class="cartao-body">
<div class="carimbos-grid">${carimbosHtml}</div>
<div class="cartao-info">
<div class="info-row">
<span>Recompensa</span>
<strong>${cartao.recompensa}</strong>
</div>
                                ${cartao.validade ? `
                                <div class="info-row">
<span>Validade</span>
<strong>${new Date(cartao.validade).toLocaleDateString('pt-BR')}</strong>
</div>
                                ` : ''}
                            </div>
<button class="btn-usar" ${!completo ? 'disabled' : ''} onclick="resgatarCartao(${cartao.id})">
                                ${completo ? 'Resgatar Recompensa' : 'Continue acumulando carimbos'}
                            </button>
</div>
</div>
                `;
            }).join('');
        }
        
        function renderEmpty() {
            document.getElementById('cartoesList').innerHTML = `
                <div class="empty-state">
<i class="fas fa-id-card"></i>
<p>Você ainda não tem cartões fidelidade</p>
<p style="margin-top: 8px; font-size: 14px;">Visite estabelecimentos e comece a acumular!</p>
</div>
            `;
            document.getElementById('totalCartoes').textContent = '0 cartões';
        }
        
        async function resgatarCartao(id) {
            if (!confirm('Deseja resgatar a recompensa deste cartão?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const baseURL = API_CONFIG.getBaseURL();
                
                const response = await fetch(`${baseURL}/api/cliente/cartoes-fidelidade/${id}/resgatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('Recompensa resgatada com sucesso!');
                    loadCartoes();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Erro ao resgatar recompensa');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao resgatar recompensa');
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadCartoes);
    </script>
</body>
</html>
