<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Empresas - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/app-unified.css">
    <link rel="stylesheet" href="/css/modern-theme.css">
    <link rel="stylesheet" href="/css/temdetudo-theme.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-container">
                <a href="/admin.html" class="logo">
                    <img src="/img/logo.png" alt="Tem de Tudo" class="logo-image">
                    <span>Tem de Tudo</span>
                </a>
                <nav class="nav-menu">
                    <a href="/admin.html"><i class="fas fa-home icon-sm"></i> Dashboard</a>
                    <a href="/admin/usuarios.html"><i class="fas fa-users icon-sm"></i> Usuários</a>
                    <a href="/admin/empresas.html" class="active"><i class="fas fa-building icon-sm"></i> Empresas</a>
                    <a href="/admin/relatorios.html"><i class="fas fa-chart-bar icon-sm"></i> Relatórios</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt icon-sm"></i> Sair</a>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <div style="max-width: 1400px; margin: 0 auto; padding: var(--space-6);">
                <!-- Page Header -->
                <div class="glass-container" style="margin-bottom: var(--space-6);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="margin: 0; font-size: 1.75rem; color: var(--gray-900);">
                                <i class="fas fa-building"></i> Gerenciar Empresas
                            </h1>
                            <p style="margin: 0.5rem 0 0; color: var(--gray-600);">
                                Cadastrar, editar, excluir e aprovar empresas
                            </p>
                        </div>
                        <button onclick="openCreateModal()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nova Empresa
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: var(--space-6);">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
                            <input type="text" id="searchInput" class="form-control" placeholder="🔍 Buscar empresa..." oninput="filterEmpresas()">
                            
                            <select id="statusFilter" class="form-control" onchange="filterEmpresas()">
                                <option value="">Todos os Status</option>
                                <option value="ativa">Ativas</option>
                                <option value="inativa">Inativas</option>
                                <option value="pendente">Pendentes</option>
                                <option value="bloqueada">Bloqueadas</option>
                            </select>

                            <select id="ramoFilter" class="form-control" onchange="filterEmpresas()">
                                <option value="">Todos os Ramos</option>
                                <option value="academia">Academia</option>
                                <option value="cafeteria">Cafeteria</option>
                                <option value="pet_shop">Pet Shop</option>
                                <option value="salao">Salão de Beleza</option>
                                <option value="mercado">Mercado</option>
                                <option value="farmacia">Farmácia</option>
                                <option value="restaurante">Restaurante</option>
                            </select>

                            <button onclick="resetFilters()" class="btn btn-outline">
                                <i class="fas fa-sync"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empresas Table -->
                <div class="card">
                    <div class="card-body">
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Logo</th>
                                        <th>Nome</th>
                                        <th>CNPJ</th>
                                        <th>Ramo</th>
                                        <th>Status</th>
                                        <th>Plano</th>
                                        <th>Clientes</th>
                                        <th>Cadastro</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="empresasTableBody">
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: var(--space-8);">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                            <p style="margin-top: var(--space-4); color: var(--gray-500);">Carregando empresas...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Criar/Editar Empresa -->
    <div id="empresaModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-building"></i> Nova Empresa</h2>
                <button onclick="closeModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="empresaForm" onsubmit="saveEmpresa(event)">
                    <input type="hidden" id="empresaId">
                    
                    <div class="grid grid-cols-2" style="gap: var(--space-4);">
                        <div class="form-group">
                            <label class="form-label">Nome da Empresa *</label>
                            <input type="text" id="nome" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">CNPJ *</label>
                            <input type="text" id="cnpj" class="form-control" placeholder="00.000.000/0000-00" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Telefone *</label>
                            <input type="tel" id="telefone" class="form-control" placeholder="(00) 00000-0000" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Ramo de Atividade *</label>
                            <select id="ramo" class="form-control" required>
                                <option value="">Selecione...</option>
                                <option value="academia">Academia</option>
                                <option value="cafeteria">Cafeteria</option>
                                <option value="pet_shop">Pet Shop</option>
                                <option value="salao">Salão de Beleza</option>
                                <option value="mercado">Mercado</option>
                                <option value="farmacia">Farmácia</option>
                                <option value="restaurante">Restaurante</option>
                                <option value="lanchonete">Lanchonete</option>
                                <option value="padaria">Padaria</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Plano *</label>
                            <select id="plano" class="form-control" required>
                                <option value="basico">Básico - R$ 49,90/mês</option>
                                <option value="profissional">Profissional - R$ 99,90/mês</option>
                                <option value="premium">Premium - R$ 199,90/mês</option>
                            </select>
                        </div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Endereço Completo *</label>
                            <input type="text" id="endereco" class="form-control" placeholder="Rua, número, bairro, cidade - UF" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">CEP</label>
                            <input type="text" id="cep" class="form-control" placeholder="00000-000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select id="status" class="form-control" required>
                                <option value="pendente">Pendente Aprovação</option>
                                <option value="ativa">Ativa</option>
                                <option value="inativa">Inativa</option>
                                <option value="bloqueada">Bloqueada</option>
                            </select>
                        </div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Logo (URL)</label>
                            <input type="url" id="logo" class="form-control" placeholder="https://exemplo.com/logo.png">
                        </div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Descrição</label>
                            <textarea id="descricao" class="form-control" rows="3" placeholder="Breve descrição da empresa..."></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-6);">
                        <button type="button" onclick="closeModal()" class="btn btn-outline">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Empresa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script>
        let empresas = [];
        let filteredEmpresas = [];
        let editingId = null;

        // Verificar autenticação
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = 'admin-login.html';
                return false;
            }
            return token;
        }

        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = 'admin-login.html';
        }

        // Carregar empresas
        async function loadEmpresas() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_CONFIG.getBaseURL()}/api/admin/empresas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    empresas = result.data || result.empresas || result;
                    filteredEmpresas = [...empresas];
                    renderEmpresas();
                } else {
                    throw new Error('Erro ao carregar empresas');
                }
            } catch (error) {
                console.error('Erro:', error);
                showEmptyState();
            }
        }

        // Renderizar tabela
        function renderEmpresas() {
            const tbody = document.getElementById('empresasTableBody');
            
            if (filteredEmpresas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: var(--space-8);">
                            <i class="fas fa-building" style="font-size: 3rem; color: var(--gray-300);"></i>
                            <p style="margin-top: var(--space-4); color: var(--gray-500);">Nenhuma empresa encontrada</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredEmpresas.map(emp => {
                const statusColors = {
                    'ativa': 'success',
                    'inativa': 'secondary',
                    'pendente': 'warning',
                    'bloqueada': 'danger'
                };

                return `
                    <tr>
                        <td>
                            ${emp.logo ? 
                                `<img src="${emp.logo}" alt="${emp.nome}" style="width: 48px; height: 48px; border-radius: 8px; object-fit: cover;">` :
                                `<div style="width: 48px; height: 48px; background: var(--gradient-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #1D1D1F; font-weight: 700;">
                                    ${emp.nome.charAt(0)}
                                </div>`
                            }
                        </td>
                        <td><strong>${emp.nome}</strong></td>
                        <td>${emp.cnpj || '-'}</td>
                        <td><span class="badge badge-info">${emp.ramo_formatado || emp.ramo || '-'}</span></td>
                        <td><span class="badge badge-${statusColors[emp.status] || 'secondary'}">${emp.status || 'pendente'}</span></td>
                        <td><span class="badge badge-primary">${emp.plano || 'Básico'}</span></td>
                        <td>${emp.total_clientes || 0}</td>
                        <td>${new Date(emp.created_at || Date.now()).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editEmpresa(${emp.id})" class="btn btn-sm btn-outline" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleStatus(${emp.id}, '${emp.status}')" class="btn btn-sm ${emp.status === 'ativa' ? 'btn-warning' : 'btn-success'}" title="${emp.status === 'ativa' ? 'Desativar' : 'Ativar'}">
                                    <i class="fas fa-${emp.status === 'ativa' ? 'pause' : 'play'}"></i>
                                </button>
                                <button onclick="deleteEmpresa(${emp.id}, '${emp.nome}')" class="btn btn-sm btn-danger" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showEmptyState() {
            const tbody = document.getElementById('empresasTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: var(--space-8);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--accent-orange);"></i>
                        <p style="margin-top: var(--space-4); color: var(--gray-600);">Erro ao carregar empresas</p>
                    </td>
                </tr>
            `;
        }

        // Filtros
        function filterEmpresas() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const ramoFilter = document.getElementById('ramoFilter').value;

            filteredEmpresas = empresas.filter(emp => {
                const matchesSearch = !searchTerm || 
                    emp.nome.toLowerCase().includes(searchTerm) ||
                    (emp.cnpj && emp.cnpj.includes(searchTerm)) ||
                    (emp.email && emp.email.toLowerCase().includes(searchTerm));

                const matchesStatus = !statusFilter || emp.status === statusFilter;
                const matchesRamo = !ramoFilter || emp.ramo === ramoFilter;

                return matchesSearch && matchesStatus && matchesRamo;
            });

            renderEmpresas();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('ramoFilter').value = '';
            filterEmpresas();
        }

        // Modal
        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-building"></i> Nova Empresa';
            document.getElementById('empresaForm').reset();
            document.getElementById('empresaModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('empresaModal').style.display = 'none';
        }

        // Editar
        function editEmpresa(id) {
            const empresa = empresas.find(e => e.id === id);
            if (!empresa) return;

            editingId = id;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Empresa';
            document.getElementById('empresaId').value = id;
            document.getElementById('nome').value = empresa.nome;
            document.getElementById('cnpj').value = empresa.cnpj || '';
            document.getElementById('email').value = empresa.email || '';
            document.getElementById('telefone').value = empresa.telefone || '';
            document.getElementById('ramo').value = empresa.ramo || '';
            document.getElementById('plano').value = empresa.plano || 'basico';
            document.getElementById('endereco').value = empresa.endereco || '';
            document.getElementById('cep').value = empresa.cep || '';
            document.getElementById('status').value = empresa.status || 'pendente';
            document.getElementById('logo').value = empresa.logo || '';
            document.getElementById('descricao').value = empresa.descricao || '';

            document.getElementById('empresaModal').style.display = 'flex';
        }

        // Salvar
        async function saveEmpresa(event) {
            event.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const formData = {
                nome: document.getElementById('nome').value,
                cnpj: document.getElementById('cnpj').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                ramo: document.getElementById('ramo').value,
                plano: document.getElementById('plano').value,
                endereco: document.getElementById('endereco').value,
                cep: document.getElementById('cep').value,
                status: document.getElementById('status').value,
                logo: document.getElementById('logo').value,
                descricao: document.getElementById('descricao').value
            };

            try {
                const url = editingId 
                    ? `${API_CONFIG.getBaseURL()}/api/admin/empresas/${editingId}`
                    : `${API_CONFIG.getBaseURL()}/api/admin/empresas`;

                const response = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert(editingId ? 'Empresa atualizada com sucesso!' : 'Empresa criada com sucesso!');
                    closeModal();
                    loadEmpresas();
                } else {
                    const error = await response.json();
                    alert('Erro: ' + (error.message || 'Não foi possível salvar a empresa'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar empresa. Tente novamente.');
            }
        }

        // Alternar status
        async function toggleStatus(id, currentStatus) {
            const token = checkAuth();
            if (!token) return;

            const newStatus = currentStatus === 'ativa' ? 'inativa' : 'ativa';

            if (!confirm(`Deseja ${newStatus === 'ativa' ? 'ativar' : 'desativar'} esta empresa?`)) return;

            try {
                const response = await fetch(`${API_CONFIG.getBaseURL()}/api/admin/empresas/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    alert('Status alterado com sucesso!');
                    loadEmpresas();
                } else {
                    alert('Erro ao alterar status');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao alterar status. Tente novamente.');
            }
        }

        // Excluir
        async function deleteEmpresa(id, nome) {
            const token = checkAuth();
            if (!token) return;

            if (!confirm(`Tem certeza que deseja EXCLUIR a empresa "${nome}"?\n\nEsta ação não pode ser desfeita!`)) return;

            try {
                const response = await fetch(`${API_CONFIG.getBaseURL()}/api/admin/empresas/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Empresa excluída com sucesso!');
                    loadEmpresas();
                } else {
                    alert('Erro ao excluir empresa');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir empresa. Tente novamente.');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadEmpresas();
        });

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('empresaModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
