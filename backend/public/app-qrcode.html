<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meu QR Code - Tem de Tudo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="/css/theme-escuro.css">
<link rel="stylesheet" href="/css/vale-bonus-theme.css">
<link rel="stylesheet" href="/css/style-unificado.css?v=3">
</head>
<body>
<div class="qr-container">
<div class="user-info">
<div class="user-avatar">
<i class="fas fa-user"></i>
</div>
<div class="user-name" id="userName">Carregando...</div>
<div class="user-id">ID: <span id="userId">---</span></div>
</div>
<div class="pontos-info">
<div class="pontos-label">Seus Pontos Disponíveis</div>
<div class="pontos-value" id="totalPontos">0</div>
<div class="pontos-subtitle">Ganhe mais pontos nas compras!</div>
</div>
<div class="qr-box">
<div id="qrcode"></div>
</div>
<div class="qr-instructions">
<div class="instruction-title">
<i class="fas fa-info-circle"></i>
                Como usar seu QR Code
            </div>
<ul class="instruction-list">
<li>
<i class="fas fa-1"></i>
<span>Mostre este QR Code no caixa do estabelecimento parceiro</span>
</li>
<li>
<i class="fas fa-2"></i>
<span>Aguarde a leitura do código</span>
</li>
<li>
<i class="fas fa-3"></i>
<span>Seus pontos serão creditados automaticamente!</span>
</li>
</ul>
</div>
<div class="action-buttons">
<button class="btn-action" onclick="compartilhar()">
<i class="fas fa-share-alt"></i>
<span>Compartilhar</span>
</button>
<button class="btn-action" onclick="baixarQR()">
<i class="fas fa-download"></i>
<span>Baixar QR</span>
</button>
<button class="btn-action" onclick="aumentarBrilho()">
<i class="fas fa-sun"></i>
<span>+ Brilho</span>
</button>
<button class="btn-action" onclick="verHistorico()">
<i class="fas fa-history"></i>
<span>Histórico</span>
</button>
</div>
</div>
<!-- Bottom Navigation -->
<nav class="bottom-nav">
<a href="/app-inicio.html" class="nav-item active">
<i class="fas fa-home"></i>
<span>Início</span>
</a>
<a href="/app-empresas.html" class="nav-item">
<i class="fas fa-store"></i>
<span>Empresas</span>
</a>
<a href="/app-promocoes.html" class="nav-item">
<i class="fas fa-tags"></i>
<span>Promoções</span>
</a>
<a href="/app-qrcode.html" class="nav-item active">
<i class="fas fa-qrcode"></i>
<span>Meu QR</span>
</a>
<a href="/app-perfil-cliente.html" class="nav-item">
<i class="fas fa-user"></i>
<span>Perfil</span>
</a>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
        // Configuração de API mais robusta
        let API_URL;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // LOCAL: Tenta várias portas comuns do Laravel
            API_URL = 'http://127.0.0.1:8000/api';
        } else if (window.location.hostname.includes('render.com') || window.location.hostname.includes('herokuapp.com')) {
            // PRODUÇÃO: Render, Heroku, etc
            API_URL = '/api';
        } else {
            // OUTROS: Relative path como fallback
            API_URL = '/api';
        }
        
        // Verificar autenticação
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        
        if (!token || !userStr || userStr === 'undefined' || userStr === 'null') {
            localStorage.clear();
            window.location.href = 'entrar.html';
        }
        
        let user;
        try {
            user = JSON.parse(userStr);
            if (!user || !user.perfil || user.perfil !== 'cliente') {
                localStorage.clear();
                window.location.href = 'entrar.html';
            }
        } catch (e) {
            localStorage.clear();
            window.location.href = 'entrar.html';
        }
        
        // Exibir dados do usuário
        document.getElementById('userName').textContent = user.name || user.email;
        document.getElementById('userId').textContent = user.id || '---';
        
        // Gerar QR Code
        function generateQRCode() {
            const qrcodeElement = document.getElementById('qrcode');
            qrcodeElement.innerHTML = '';
            
            new QRCode(qrcodeElement, {
                text: `TDT-USER-${user.id}`,
                width: 280,
                height: 280,
                colorDark: '#1e293b',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // Carregar pontos
        async function loadPontos() {
            try {
                const response = await fetch(`${API_URL}/cliente/pontos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const pontos = data.total || data.pontos || 0;
                    document.getElementById('totalPontos').textContent = pontos;
                }
            } catch (error) {
                console.error('Erro ao carregar pontos:', error);
            }
        }
        
        function compartilhar() {
            if (navigator.share) {
                navigator.share({
                    title: 'Meu QR Code - Tem de Tudo',
                    text: 'Confira meu QR Code de fidelidade!',
                    url: window.location.href
                }).catch(err => console.log('Erro ao compartilhar:', err));
            } else {
                alert('Compartilhamento não suportado neste navegador');
            }
        }
        
        function baixarQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `qrcode-temdetudo-${user.id}.png`;
                link.href = url;
                link.click();
            }
        }
        
        function aumentarBrilho() {
            if (document.body.style.filter === 'brightness(1.5)') {
                document.body.style.filter = '';
            } else {
                document.body.style.filter = 'brightness(1.5)';
            }
        }
        
        function verHistorico() {
            window.location.href = '/app-historico.html';
        }
        
        // Inicializar
        generateQRCode();
        loadPontos();
    </script>
</body>
</html>
