<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Histórico de Pontos - Tem de Tudo</title>
<meta name="description" content="Acompanhe todo o histórico das suas transações de pontos">
<meta name="theme-color" content="#6F1AB6">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="js/config.js"></script>
<script src="js/auth-guard.js"></script>


<link rel="stylesheet" href="css/vivo-styles.css">
</head>
<body>
<div class="app-page">
    <!-- Header -->
    <div class="app-header">
        <div class="header-nav">
            <button class="back-btn" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1>Histórico de Pontos</h1>
            <div style="width: 40px;"></div>
        </div>
    </div>

    <!-- Content -->
    <div class="app-content">
        <!-- Statistics Cards -->
        <div class="section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalGanho">0</div>
                    <div class="stat-label">Pontos Ganhos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalResgate">0</div>
                    <div class="stat-label">Pontos Usados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransacoes">0</div>
                    <div class="stat-label">Transações</div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="section">
            <div class="filter-tabs">
                <div class="filter-tab active" data-filter="todos" onclick="filtrar('todos')">
                    <i class="fas fa-list"></i> 
                    <span>Todos</span>
                </div>
                <div class="filter-tab" data-filter="ganho" onclick="filtrar('ganho')">
                    <i class="fas fa-plus-circle"></i> 
                    <span>Ganhos</span>
                </div>
                <div class="filter-tab" data-filter="resgate" onclick="filtrar('resgate')">
                    <i class="fas fa-gift"></i> 
                    <span>Resgates</span>
                </div>
                <div class="filter-tab" data-filter="expiracao" onclick="filtrar('expiracao')">
                    <i class="fas fa-clock"></i> 
                    <span>Expirações</span>
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="section">
            <div class="timeline" id="timeline">
                <!-- Timeline items will be generated here -->
            </div>
            
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-history"></i>
                <p>Nenhuma transaçáo encontrada</p>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <div class="nav-container">
        <a href="dashboard-cliente.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Início</span>
        </a>
        <a href="app-empresas.html" class="nav-item">
            <i class="fas fa-search"></i>
            <span>Explorar</span>
        </a>
        <a href="app-pontos.html" class="nav-item active">
            <i class="fas fa-star"></i>
            <span>Pontos</span>
        </a>
        <a href="app-promocoes.html" class="nav-item">
            <i class="fas fa-tags"></i>
            <span>Ofertas</span>
        </a>
        <a href="app-perfil.html" class="nav-item">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </a>
    </div>
</div>

<script>
const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : '/';
let historico = [];
let filtroAtual = 'todos';

const icones = {
    ganho: 'fa-plus-circle',
    checkin: 'fa-check-circle', 
    resgate: 'fa-gift',
    expiracao: 'fa-clock'
};

document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'entrar.html';
        return;
    }
    await carregarHistorico();
});

async function carregarHistorico() {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`${API_BASE_URL}api/historico`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
                historico = data.data;
            } else {
                // Dados de exemplo para demonstraçáo
                historico = gerarHistoricoExemplo();
            }
        } else {
            historico = gerarHistoricoExemplo();
        }
    } catch (error) {
        console.error('Erro ao carregar histórico:', error);
        historico = gerarHistoricoExemplo();
    }
    
    calcularEstatisticas();
    renderizarHistorico();
}

function gerarHistoricoExemplo() {
    const hoje = new Date();
    const ontem = new Date(hoje.getTime() - 24 * 60 * 60 * 1000);
    const anteontem = new Date(hoje.getTime() - 48 * 60 * 60 * 1000);
    
    return [
        {
            tipo: 'ganho',
            pontos: 150,
            descricao: 'Compra no estabelecimento',
            empresa: 'Padaria do Joáo',
            created_at: hoje.toISOString()
        },
        {
            tipo: 'checkin',
            pontos: 50,
            descricao: 'Check-in diário',
            empresa: 'Sistema',
            created_at: hoje.toISOString()
        },
        {
            tipo: 'resgate',
            pontos: -100,
            descricao: 'Cupom de desconto 10%',
            empresa: 'Loja de Roupas',
            created_at: ontem.toISOString()
        },
        {
            tipo: 'ganho',
            pontos: 200,
            descricao: 'Compra premiada',
            empresa: 'Super Mercado',
            created_at: anteontem.toISOString()
        },
        {
            tipo: 'expiracao',
            pontos: -25,
            descricao: 'Pontos expirados',
            empresa: 'Sistema',
            created_at: anteontem.toISOString()
        }
    ];
}

function calcularEstatisticas() {
    const ganhos = historico.filter(h => h.tipo === 'ganho' || h.tipo === 'checkin')
        .reduce((sum, h) => sum + (h.pontos || 0), 0);
    
    const resgates = historico.filter(h => h.tipo === 'resgate' || h.tipo === 'expiracao')
        .reduce((sum, h) => sum + Math.abs(h.pontos || 0), 0);
    
    document.getElementById('totalGanho').textContent = formatNumber(ganhos);
    document.getElementById('totalResgate').textContent = formatNumber(resgates);
    document.getElementById('totalTransacoes').textContent = historico.length;
}

function filtrar(tipo) {
    filtroAtual = tipo;
    
    // Atualizar tabs ativas
    document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`[data-filter="${tipo}"]`).classList.add('active');
    
    renderizarHistorico();
}

function renderizarHistorico() {
    let dados = historico;
    if (filtroAtual !== 'todos') {
        dados = historico.filter(h => h.tipo === filtroAtual);
    }
    
    const timeline = document.getElementById('timeline');
    const empty = document.getElementById('emptyState');
    
    if (dados.length === 0) {
        timeline.style.display = 'none';
        empty.style.display = 'block';
        return;
    }
    
    timeline.style.display = 'block';
    empty.style.display = 'none';
    
    // Ordenar por data mais recente
    dados.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    timeline.innerHTML = dados.map(h => `
        <div class="timeline-item">
            <div class="timeline-icon ${h.tipo}">
                <i class="fas ${icones[h.tipo] || 'fa-circle'}"></i>
            </div>
            <div class="timeline-content">
                <div class="timeline-header">
                    <div class="timeline-title">${h.descricao || getTipoLabel(h.tipo)}</div>
                    <div class="timeline-points ${h.pontos > 0 ? 'positive' : 'negative'}">
                        ${h.pontos > 0 ? '+' : ''}${formatNumber(h.pontos)} pts
                    </div>
                </div>
                <div class="timeline-desc">${h.empresa || 'Sistema'}</div>
                <div class="timeline-date">${formatDate(h.created_at)}</div>
            </div>
        </div>
    `).join('');
}

function getTipoLabel(tipo) {
    const labels = {
        ganho: 'Pontos Ganhos',
        checkin: 'Check-in',
        resgate: 'Resgate de Pontos',
        expiracao: 'Pontos Expirados'
    };
    return labels[tipo] || tipo;
}

function formatNumber(num) {
    return new Intl.NumberFormat('pt-BR').format(Math.abs(num));
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Hoje, ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    if (diffDays === 1) return 'Ontem, ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function mostrarFeedback(mensagem, tipo) {
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: var(--vivo-purple); color: white;
        padding: 1rem 1.5rem; border-radius: var(--border-radius); font-weight: 600; z-index: 10000;
        box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.5rem; max-width: 300px;
    `;
    
    if (tipo === 'success') {
        feedback.style.background = 'var(--vivo-green)';
    } else if (tipo === 'error') {
        feedback.style.background = 'var(--vivo-red)';
    }
    
    feedback.innerHTML = `<i class="fas fa-info-circle"></i> ${mensagem}`;
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 3000);
}
</script>
</body>
</html>

