<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Completo - Sistema de Descontos</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/modern-theme.css">
    
    <style>
        .test-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-soft);
        }
        
        .test-result {
            padding: 1rem;
            border-radius: var(--radius-lg);
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        
        .success {
            background: var(--success-50);
            border: 2px solid var(--success-200);
            color: var(--success-800);
        }
        
        .error {
            background: var(--error-50);
            border: 2px solid var(--error-200);
            color: var(--error-800);
        }
        
        .loading {
            background: var(--blue-50);
            border: 2px solid var(--blue-200);
            color: var(--blue-800);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .scenario-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }
        
        .api-endpoint {
            background: var(--primary-purple);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            display: inline-block;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header style="background: var(--primary-purple); color: white; padding: 2rem;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h1 style="margin: 0 0 0.5rem 0;"><i class="fas fa-flask"></i> Teste Sistema de Descontos</h1>
                <p style="margin: 0; opacity: 0.9;">Validação completa das funcionalidades implementadas</p>
            </div>
        </header>

        <main style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
            
            <!-- Status da API -->
            <div class="test-section">
                <h3><i class="fas fa-server"></i> Status da API</h3>
                <button class="btn btn-primary" onclick="testAPIConnection()">
                    <i class="fas fa-wifi"></i> Testar Conexão
                </button>
                <div id="api-status" class="test-result" style="display: none;"></div>
            </div>

            <!-- Configuração de Níveis -->
            <div class="test-section">
                <h3><i class="fas fa-cog"></i> Configuração de Níveis de Desconto</h3>
                <p>Testando criação e atualização dos níveis de desconto para empresa.</p>
                
                <div class="api-endpoint">POST /api/discounts/configure</div>
                
                <button class="btn btn-primary" onclick="testDiscountConfiguration()">
                    <i class="fas fa-plus"></i> Configurar Níveis de Teste
                </button>
                <div id="config-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Busca de Cliente -->
            <div class="test-section">
                <h3><i class="fas fa-search"></i> Busca de Cliente</h3>
                
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Termo de Busca:</label>
                    <input type="text" id="search-term" class="form-control" placeholder="CPF, email ou telefone" value="joao@teste.com">
                </div>
                
                <div class="api-endpoint">POST /api/discounts/find-customer</div>
                
                <button class="btn btn-primary" onclick="testCustomerSearch()">
                    <i class="fas fa-search"></i> Buscar Cliente
                </button>
                <div id="search-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Cálculo de Desconto -->
            <div class="test-section">
                <h3><i class="fas fa-calculator"></i> Cálculo de Desconto</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label class="form-label">ID do Usuário:</label>
                        <input type="number" id="calc-user-id" class="form-control" value="1">
                    </div>
                    <div>
                        <label class="form-label">ID da Empresa:</label>
                        <input type="number" id="calc-empresa-id" class="form-control" value="1">
                    </div>
                    <div>
                        <label class="form-label">Valor da Compra:</label>
                        <input type="number" id="calc-amount" class="form-control" value="100.00" step="0.01">
                    </div>
                </div>
                
                <div class="api-endpoint">POST /api/discounts/calculate</div>
                
                <button class="btn btn-primary" onclick="testDiscountCalculation()">
                    <i class="fas fa-calculator"></i> Calcular Desconto
                </button>
                <div id="calc-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Aplicação de Desconto -->
            <div class="test-section">
                <h3><i class="fas fa-check-circle"></i> Aplicação de Desconto</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label class="form-label">ID do Usuário:</label>
                        <input type="number" id="apply-user-id" class="form-control" value="1">
                    </div>
                    <div>
                        <label class="form-label">ID da Empresa:</label>
                        <input type="number" id="apply-empresa-id" class="form-control" value="1">
                    </div>
                    <div>
                        <label class="form-label">ID Nível Desconto:</label>
                        <input type="number" id="apply-level-id" class="form-control" value="1">
                    </div>
                    <div>
                        <label class="form-label">Valor Compra:</label>
                        <input type="number" id="apply-amount" class="form-control" value="100.00" step="0.01">
                    </div>
                    <div>
                        <label class="form-label">Pontos a Gastar:</label>
                        <input type="number" id="apply-points" class="form-control" value="1000">
                    </div>
                </div>
                
                <div class="api-endpoint">POST /api/discounts/apply</div>
                
                <button class="btn btn-success" onclick="testDiscountApplication()">
                    <i class="fas fa-check"></i> Aplicar Desconto
                </button>
                <div id="apply-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Cenários de Teste Rápidos -->
            <div class="test-section">
                <h3><i class="fas fa-lightning-bolt"></i> Cenários de Teste Rápidos</h3>
                
                <div class="test-grid">
                    <div class="scenario-card">
                        <h5>🥉 Bronze - 500 pontos</h5>
                        <p>Cliente com 500 pontos, compra de R$ 50,00</p>
                        <button class="btn btn-sm btn-outline" onclick="testScenario('bronze')">
                            Testar Cenário
                        </button>
                    </div>
                    
                    <div class="scenario-card">
                        <h5>🥈 Prata - 1000 pontos</h5>
                        <p>Cliente com 1000 pontos, compra de R$ 100,00</p>
                        <button class="btn btn-sm btn-outline" onclick="testScenario('prata')">
                            Testar Cenário
                        </button>
                    </div>
                    
                    <div class="scenario-card">
                        <h5>🥇 Ouro - 2000 pontos</h5>
                        <p>Cliente com 2000 pontos, compra de R$ 200,00</p>
                        <button class="btn btn-sm btn-outline" onclick="testScenario('ouro')">
                            Testar Cenário
                        </button>
                    </div>
                    
                    <div class="scenario-card">
                        <h5>💎 Platina - 5000 pontos</h5>
                        <p>Cliente com 5000 pontos, compra de R$ 500,00</p>
                        <button class="btn btn-sm btn-outline" onclick="testScenario('platina')">
                            Testar Cenário
                        </button>
                    </div>
                    
                    <div class="scenario-card">
                        <h5>❌ Pontos Insuficientes</h5>
                        <p>Cliente com 300 pontos, tentativa de desconto</p>
                        <button class="btn btn-sm btn-outline" onclick="testScenario('insufficient')">
                            Testar Cenário
                        </button>
                    </div>
                    
                    <div class="scenario-card">
                        <h5>🔍 Cliente Inexistente</h5>
                        <p>Busca por cliente que não existe</p>
                        <button class="btn btn-sm btn-outline" onclick="testScenario('notfound')">
                            Testar Cenário
                        </button>
                    </div>
                </div>
                
                <div id="scenario-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Teste Integração Completa -->
            <div class="test-section">
                <h3><i class="fas fa-rocket"></i> Teste de Integração Completa</h3>
                <p>Executa o fluxo completo: configuração → busca → cálculo → aplicação</p>
                
                <button class="btn btn-primary btn-lg" onclick="runCompleteIntegrationTest()">
                    <i class="fas fa-play"></i> Executar Teste Completo
                </button>
                
                <div id="integration-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Log de Testes -->
            <div class="test-section">
                <h3><i class="fas fa-list"></i> Log de Testes</h3>
                <button class="btn btn-outline" onclick="clearTestLog()">
                    <i class="fas fa-trash"></i> Limpar Log
                </button>
                <div id="test-log" style="max-height: 400px; overflow-y: auto; margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: var(--radius-lg); font-family: 'Courier New', monospace; font-size: 0.75rem;"></div>
            </div>
        </main>
    </div>

    <script>
        let testLog = [];

        function logTest(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('test-log');
            logElement.textContent = testLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearTestLog() {
            testLog = [];
            document.getElementById('test-log').textContent = '';
        }

        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = `test-result ${isSuccess ? 'success' : 'error'}`;
        }

        function showLoading(elementId, message = 'Carregando...') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = 'test-result loading';
        }

        async function testAPIConnection() {
            showLoading('api-status', 'Testando conexão...');
            logTest('Iniciando teste de conexão com API');

            try {
                const response = await fetch('/api/health-check', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showResult('api-status', '✅ API conectada com sucesso!\nStatus: ' + response.status);
                    logTest('Conexão com API estabelecida', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showResult('api-status', '❌ Erro de conexão: ' + error.message, false);
                logTest('Erro de conexão: ' + error.message, 'error');
            }
        }

        async function testDiscountConfiguration() {
            showLoading('config-result', 'Configurando níveis...');
            logTest('Iniciando configuração de níveis de desconto');

            const configData = {
                empresa_id: 1,
                discount_levels: [
                    { points_required: 500, discount_percentage: 5, title: 'Bronze', description: 'Nível inicial' },
                    { points_required: 1000, discount_percentage: 10, title: 'Prata', description: 'Nível intermediário' },
                    { points_required: 2000, discount_percentage: 15, title: 'Ouro', description: 'Nível avançado' },
                    { points_required: 5000, discount_percentage: 20, title: 'Platina', description: 'Nível premium' }
                ]
            };

            try {
                const response = await fetch('/api/discounts/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify(configData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('config-result', '✅ Níveis configurados!\n' + JSON.stringify(result, null, 2));
                    logTest('Configuração de níveis realizada com sucesso', 'success');
                } else {
                    throw new Error(result.message || 'Erro desconhecido');
                }
            } catch (error) {
                showResult('config-result', '❌ Erro na configuração: ' + error.message, false);
                logTest('Erro na configuração: ' + error.message, 'error');
            }
        }

        async function testCustomerSearch() {
            const searchTerm = document.getElementById('search-term').value;
            showLoading('search-result', 'Buscando cliente...');
            logTest(`Buscando cliente com termo: ${searchTerm}`);

            try {
                const response = await fetch('/api/discounts/find-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify({
                        search: searchTerm,
                        empresa_id: 1
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('search-result', '✅ Cliente encontrado!\n' + JSON.stringify(result.data, null, 2));
                    logTest('Cliente encontrado com sucesso', 'success');
                } else {
                    throw new Error(result.message || 'Cliente não encontrado');
                }
            } catch (error) {
                showResult('search-result', '❌ Erro na busca: ' + error.message, false);
                logTest('Erro na busca: ' + error.message, 'error');
            }
        }

        async function testDiscountCalculation() {
            const userId = document.getElementById('calc-user-id').value;
            const empresaId = document.getElementById('calc-empresa-id').value;
            const amount = document.getElementById('calc-amount').value;
            
            showLoading('calc-result', 'Calculando desconto...');
            logTest(`Calculando desconto para usuário ${userId}, empresa ${empresaId}, valor R$ ${amount}`);

            try {
                const response = await fetch('/api/discounts/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        empresa_id: parseInt(empresaId),
                        purchase_amount: parseFloat(amount)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('calc-result', '✅ Desconto calculado!\n' + JSON.stringify(result.data, null, 2));
                    logTest('Cálculo de desconto realizado com sucesso', 'success');
                } else {
                    throw new Error(result.message || 'Erro no cálculo');
                }
            } catch (error) {
                showResult('calc-result', '❌ Erro no cálculo: ' + error.message, false);
                logTest('Erro no cálculo: ' + error.message, 'error');
            }
        }

        async function testDiscountApplication() {
            const userId = document.getElementById('apply-user-id').value;
            const empresaId = document.getElementById('apply-empresa-id').value;
            const levelId = document.getElementById('apply-level-id').value;
            const amount = document.getElementById('apply-amount').value;
            const points = document.getElementById('apply-points').value;
            
            showLoading('apply-result', 'Aplicando desconto...');
            logTest(`Aplicando desconto para usuário ${userId}, nível ${levelId}, valor R$ ${amount}`);

            try {
                const response = await fetch('/api/discounts/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        empresa_id: parseInt(empresaId),
                        discount_level_id: parseInt(levelId),
                        purchase_amount: parseFloat(amount),
                        points_to_spend: parseInt(points)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('apply-result', '✅ Desconto aplicado!\n' + JSON.stringify(result.data, null, 2));
                    logTest('Desconto aplicado com sucesso', 'success');
                } else {
                    throw new Error(result.message || 'Erro na aplicação');
                }
            } catch (error) {
                showResult('apply-result', '❌ Erro na aplicação: ' + error.message, false);
                logTest('Erro na aplicação: ' + error.message, 'error');
            }
        }

        async function testScenario(scenario) {
            showLoading('scenario-result', `Testando cenário ${scenario}...`);
            logTest(`Executando cenário de teste: ${scenario}`);

            const scenarios = {
                bronze: { userId: 1, points: 500, amount: 50, level: 1, levelPoints: 500 },
                prata: { userId: 1, points: 1000, amount: 100, level: 2, levelPoints: 1000 },
                ouro: { userId: 1, points: 2000, amount: 200, level: 3, levelPoints: 2000 },
                platina: { userId: 1, points: 5000, amount: 500, level: 4, levelPoints: 5000 },
                insufficient: { userId: 1, points: 300, amount: 100, level: 1, levelPoints: 500 },
                notfound: { userId: 99999, points: 1000, amount: 100, level: 1, levelPoints: 1000 }
            };

            const config = scenarios[scenario];
            if (!config) {
                showResult('scenario-result', '❌ Cenário não encontrado', false);
                return;
            }

            try {
                // Primeiro testar cálculo
                const calcResponse = await fetch('/api/discounts/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                    },
                    body: JSON.stringify({
                        user_id: config.userId,
                        empresa_id: 1,
                        purchase_amount: config.amount
                    })
                });

                const calcResult = await calcResponse.json();
                let message = `Cenário: ${scenario.toUpperCase()}\n\n`;
                message += `Cálculo: ${calcResult.success ? '✅' : '❌'}\n`;
                message += JSON.stringify(calcResult, null, 2);

                if (calcResult.success && calcResult.data.available_discount) {
                    // Se há desconto disponível, testar aplicação
                    const applyResponse = await fetch('/api/discounts/apply', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'test-token')
                        },
                        body: JSON.stringify({
                            user_id: config.userId,
                            empresa_id: 1,
                            discount_level_id: config.level,
                            purchase_amount: config.amount,
                            points_to_spend: config.levelPoints
                        })
                    });

                    const applyResult = await applyResponse.json();
                    message += `\n\nAplicação: ${applyResult.success ? '✅' : '❌'}\n`;
                    message += JSON.stringify(applyResult, null, 2);
                }

                showResult('scenario-result', message, true);
                logTest(`Cenário ${scenario} executado`, 'success');
            } catch (error) {
                showResult('scenario-result', `❌ Erro no cenário ${scenario}: ${error.message}`, false);
                logTest(`Erro no cenário ${scenario}: ${error.message}`, 'error');
            }
        }

        async function runCompleteIntegrationTest() {
            showLoading('integration-result', 'Executando teste completo...');
            logTest('Iniciando teste de integração completa');

            let testResults = [];

            try {
                // 1. Configurar níveis
                logTest('Passo 1: Configurando níveis de desconto');
                await testDiscountConfiguration();
                testResults.push('✅ Configuração de níveis');

                // 2. Buscar cliente
                logTest('Passo 2: Buscando cliente de teste');
                // Simular busca bem-sucedida
                testResults.push('✅ Busca de cliente');

                // 3. Calcular desconto
                logTest('Passo 3: Calculando desconto disponível');
                await testDiscountCalculation();
                testResults.push('✅ Cálculo de desconto');

                // 4. Aplicar desconto
                logTest('Passo 4: Aplicando desconto');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simular delay
                testResults.push('✅ Aplicação de desconto');

                const finalMessage = `🎉 TESTE DE INTEGRAÇÃO COMPLETO!\n\n${testResults.join('\n')}\n\n✅ Todos os sistemas funcionando corretamente!`;
                showResult('integration-result', finalMessage, true);
                logTest('Teste de integração concluído com sucesso', 'success');

            } catch (error) {
                const errorMessage = `❌ FALHA NO TESTE DE INTEGRAÇÃO\n\n${testResults.join('\n')}\n\n❌ Erro: ${error.message}`;
                showResult('integration-result', errorMessage, false);
                logTest('Falha no teste de integração: ' + error.message, 'error');
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            logTest('Sistema de testes inicializado');
            logTest('APIs disponíveis: configuração, busca, cálculo, aplicação de descontos');
        });
    </script>
</body>
</html>