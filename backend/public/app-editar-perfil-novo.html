<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil - Tem de Tudo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/theme-escuro.css">
    <style>
        body { background: #0a0a0f; color: #fff; padding-bottom: 100px; }
        .header { background: linear-gradient(145deg, #667eea, #764ba2); padding: 60px 20px 30px; text-align: center; position: relative; }
        .btn-back { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; width: 40px; height: 40px; border-radius: 12px; color: white; font-size: 18px; cursor: pointer; }
        .container { max-width: 600px; margin: -20px auto 0; padding: 0 20px; }
        .form-card { background: linear-gradient(145deg, #1a1a2e, #16213e); border-radius: 24px; padding: 24px; margin-bottom: 20px; border: 1px solid rgba(102, 126, 234, 0.1); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #b0b0b0; }
        .form-input { width: 100%; padding: 14px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 12px; color: white; font-size: 15px; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .btn-save { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 16px; font-size: 18px; font-weight: 700; cursor: pointer; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5); }
    </style>
    <link rel="stylesheet" href="/css/vale-bonus-theme.css">
</head>
<body>
    <div class="header">
        <button class="btn-back" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <h1><i class="fas fa-user-edit"></i> Editar Perfil</h1>
    </div>
    
    <div class="container">
        <div class="form-card">
            <form id="formEditarPerfil" onsubmit="salvarPerfil(event)">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" class="form-input" id="nome" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" class="form-input" id="telefone" placeholder="(11) 99999-9999">
                </div>
                
                <div class="form-group">
                    <label class="form-label">CPF</label>
                    <input type="text" class="form-input" id="cpf" placeholder="000.000.000-00">
                </div>
                
                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://tem-de-tudo.onrender.com';
        
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                document.getElementById('nome').value = user.nome || user.name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('telefone').value = user.telefone || '';
                document.getElementById('cpf').value = user.cpf || '';
            }
        });
        
        async function salvarPerfil(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Você precisa estar logado');
                window.location.href = '/entrar.html';
                return;
            }
            
            const dados = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                cpf: document.getElementById('cpf').value
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/perfil`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Atualizar localStorage
                    const user = JSON.parse(localStorage.getItem('user'));
                    Object.assign(user, dados);
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    alert('✅ Perfil atualizado com sucesso!');
                    history.back();
                } else {
                    alert('❌ ' + (data.message || 'Erro ao atualizar perfil'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('❌ Erro ao conectar com o servidor');
            }
        }
    </script>
</body>
</html>
