<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Notificações - Tem de Tudo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding-bottom: 100px; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px 20px;
            color: white;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .btn-back {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .form-container {
            padding: 20px;
        }
        
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        .required {
            color: #c62828;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .char-counter.warning {
            color: #ff9800;
        }
        
        .char-counter.error {
            color: #c62828;
        }
        
        .target-options {
            display: grid;
            gap: 10px;
        }
        
        .target-option {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .target-option:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }
        
        .target-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
        }
        
        .target-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
        
        .target-option.selected .target-icon {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .target-info h4 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .target-info p {
            font-size: 13px;
            color: #666;
        }
        
        .target-count {
            margin-left: auto;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .preview-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            background: #f9f9f9;
        }
        
        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .preview-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .preview-title {
            font-weight: 600;
            color: #333;
        }
        
        .preview-body {
            color: #666;
            line-height: 1.5;
        }
        
        .preview-time {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        .info-box {
            background: #fff4e6;
            border-left: 4px solid #ff9800;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            margin-top: 15px;
        }
        
        .buttons-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-cancel {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <button class="btn-back" onclick="window.location.href='/empresa-dashboard.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-title">Enviar Notificações</div>
        </div>
        <p style="opacity:0.9;">Mantenha seus clientes informados</p>
    </div>

    <form id="notificationForm" class="form-container">
        <div class="form-card">
            <div class="section-title">
                <i class="fas fa-users"></i>
                Para Quem Enviar
            </div>
            
            <div class="target-options">
                <div class="target-option selected" data-target="todos" onclick="selecionarAlvo(this)">
                    <div class="target-icon"><i class="fas fa-users"></i></div>
                    <div class="target-info">
                        <h4>Todos os Clientes</h4>
                        <p>Enviar para todos que já visitaram</p>
                    </div>
                    <div class="target-count" id="countTodos">0</div>
                </div>
                
                <div class="target-option" data-target="ativos" onclick="selecionarAlvo(this)">
                    <div class="target-icon"><i class="fas fa-star"></i></div>
                    <div class="target-info">
                        <h4>Clientes Ativos</h4>
                        <p>Visitaram nos últimos 30 dias</p>
                    </div>
                    <div class="target-count" id="countAtivos">0</div>
                </div>
                
                <div class="target-option" data-target="inativos" onclick="selecionarAlvo(this)">
                    <div class="target-icon"><i class="fas fa-bed"></i></div>
                    <div class="target-info">
                        <h4>Clientes Inativos</h4>
                        <p>Não visitam há mais de 30 dias</p>
                    </div>
                    <div class="target-count" id="countInativos">0</div>
                </div>
                
                <div class="target-option" data-target="vip" onclick="selecionarAlvo(this)">
                    <div class="target-icon"><i class="fas fa-crown"></i></div>
                    <div class="target-info">
                        <h4>Clientes VIP</h4>
                        <p>Com mais de 100 pontos</p>
                    </div>
                    <div class="target-count" id="countVip">0</div>
                </div>
            </div>
            
            <input type="hidden" id="targetGroup" value="todos">
        </div>

        <div class="form-card">
            <div class="section-title">
                <i class="fas fa-edit"></i>
                Conteúdo da Notificação
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    Título <span class="required">*</span>
                </label>
                <input type="text" class="form-input" id="titulo" maxlength="50" required 
                       placeholder="Ex: Nova Promoção Exclusiva!" oninput="atualizarPreview()">
                <div class="char-counter">
                    <span id="tituloCount">0</span>/50 caracteres
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    Mensagem <span class="required">*</span>
                </label>
                <textarea class="form-input" id="mensagem" maxlength="150" required 
                          placeholder="Digite sua mensagem..." oninput="atualizarPreview()"></textarea>
                <div class="char-counter">
                    <span id="mensagemCount">0</span>/150 caracteres
                </div>
            </div>
        </div>

        <div class="form-card">
            <div class="section-title">
                <i class="fas fa-eye"></i>
                Pré-visualização
            </div>
            
            <div class="preview-card">
                <div class="preview-header">
                    <div class="preview-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <div>
                        <div class="preview-title" id="previewTitulo">Título da notificação</div>
                        <div style="font-size:12px;color:#999;">Tem de Tudo</div>
                    </div>
                </div>
                <div class="preview-body" id="previewMensagem">
                    Sua mensagem aparecerá aqui...
                </div>
                <div class="preview-time">Agora</div>
            </div>
            
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                As notificações serão enviadas apenas para clientes com notificações ativas
            </div>
        </div>
    </form>

    <div class="buttons-container">
        <button type="button" class="btn btn-cancel" onclick="window.history.back()">
            <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-send" id="btnEnviar" onclick="enviarNotificacao()">
            <i class="fas fa-paper-plane"></i> Enviar Agora
        </button>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        let targetGroup = 'todos';

        async function carregarEstatisticas() {
            try {
                const res = await fetch('/api/empresa/notificacoes/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('countTodos').textContent = data.data.todos || 0;
                    document.getElementById('countAtivos').textContent = data.data.ativos || 0;
                    document.getElementById('countInativos').textContent = data.data.inativos || 0;
                    document.getElementById('countVip').textContent = data.data.vip || 0;
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        function selecionarAlvo(element) {
            document.querySelectorAll('.target-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            targetGroup = element.dataset.target;
            document.getElementById('targetGroup').value = targetGroup;
        }

        function atualizarPreview() {
            const titulo = document.getElementById('titulo').value || 'Título da notificação';
            const mensagem = document.getElementById('mensagem').value || 'Sua mensagem aparecerá aqui...';
            
            document.getElementById('previewTitulo').textContent = titulo;
            document.getElementById('previewMensagem').textContent = mensagem;
            
            // Atualizar contadores
            const tituloCount = document.getElementById('titulo').value.length;
            const mensagemCount = document.getElementById('mensagem').value.length;
            
            document.getElementById('tituloCount').textContent = tituloCount;
            document.getElementById('mensagemCount').textContent = mensagemCount;
            
            const tituloCounter = document.getElementById('tituloCount').parentElement;
            const mensagemCounter = document.getElementById('mensagemCount').parentElement;
            
            tituloCounter.className = 'char-counter' + (tituloCount > 45 ? ' warning' : '') + (tituloCount === 50 ? ' error' : '');
            mensagemCounter.className = 'char-counter' + (mensagemCount > 135 ? ' warning' : '') + (mensagemCount === 150 ? ' error' : '');
        }

        async function enviarNotificacao() {
            const titulo = document.getElementById('titulo').value.trim();
            const mensagem = document.getElementById('mensagem').value.trim();
            
            if (!titulo || !mensagem) {
                alert('Por favor, preencha todos os campos obrigatórios');
                return;
            }
            
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                const res = await fetch('/api/empresa/notificacoes/enviar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        titulo: titulo,
                        mensagem: mensagem,
                        target: targetGroup
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(`Notificação enviada com sucesso para ${data.enviados} cliente(s)!`);
                    window.location.href = '/empresa-dashboard.html';
                } else {
                    alert(data.message || 'Erro ao enviar notificação');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Agora';
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar notificação. Tente novamente.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Agora';
            }
        }

        carregarEstatisticas();
    </script>
</body>
</html>
