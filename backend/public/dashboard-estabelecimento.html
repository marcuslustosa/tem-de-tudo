<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Estabelecimento - Tem de Tudo</title>
    <link rel="stylesheet" href="/css/modern-theme.css" />
</head>
<body>
    <header class="header">
        <h1 class="title">Dashboard Estabelecimento</h1>
        <p class="welcome text-lg" id="welcome-message">Carregando informações...</p>
    </header>

    <section class="container glass-card p-4 mb-4">
        <h2 class="text-xl font-semibold mb-3">Estatísticas</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats-cards">
            <div class="card p-4 shadow rounded" id="total-clientes">Total de Clientes: ...</div>
            <div class="card p-4 shadow rounded" id="pontos-distribuidos">Pontos Distribuídos: ...</div>
            <div class="card p-4 shadow rounded" id="qrcodes-ativos">QRCodes Ativos: ...</div>
            <div class="card p-4 shadow rounded" id="checkins-hoje">Checkins Hoje: ...</div>
        </div>
    </section>

    <section class="container glass-card p-4 mb-4">
        <h2 class="text-xl font-semibold mb-3">Checkins Recentes</h2>
        <ul class="divide-y divide-gray-300" id="recent-checkins-list">
            <li class="py-2">Carregando checkins...</li>
        </ul>
    </section>

    <section class="container glass-card p-4">
        <h2 class="text-xl font-semibold mb-3">Top Clientes</h2>
        <ul class="divide-y divide-gray-300" id="top-clientes-list">
            <li class="py-2">Carregando top clientes...</li>
        </ul>
    </section>

    <script>
        async function loadDashboard() {
            try {
                const [
                    statsRes,
                    recentCheckinsRes,
                    topClientesRes,
                    userRes
                ] = await Promise.all([
                    fetch('/api/empresa/dashboard-stats', { credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' } }),
                    fetch('/api/empresa/recent-checkins', { credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' } }),
                    fetch('/api/empresa/top-clientes', { credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' } }),
                    fetch('/api/user', { credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' } }),
                ]);

                if (!statsRes.ok || !recentCheckinsRes.ok || !topClientesRes.ok || !userRes.ok) {
                    throw new Error('Erro ao carregar dados do dashboard.');
                }

                const statsData = await statsRes.json();
                const recentCheckinsData = await recentCheckinsRes.json();
                const topClientesData = await topClientesRes.json();
                const userData = await userRes.json();

                // Welcome message
                const welcomeMsg = document.getElementById('welcome-message');
                if (userData.success) {
                    welcomeMsg.textContent = `Bem-vindo, ${userData.data.user.name}!`;
                } else {
                    welcomeMsg.textContent = 'Bem-vindo, usuário!';
                }

                // Estatísticas
                if (statsData.success) {
                    document.getElementById('total-clientes').textContent = `Total de Clientes: ${statsData.data.total_clientes}`;
                    document.getElementById('pontos-distribuidos').textContent = `Pontos Distribuídos: ${statsData.data.pontos_distribuidos}`;
                    document.getElementById('qrcodes-ativos').textContent = `QRCodes Ativos: ${statsData.data.qrcodes_ativos}`;
                    document.getElementById('checkins-hoje').textContent = `Checkins Hoje: ${statsData.data.checkins_hoje}`;
                } else {
                    document.getElementById('total-clientes').textContent = 'Erro ao carregar estatísticas';
                    document.getElementById('pontos-distribuidos').textContent = '';
                    document.getElementById('qrcodes-ativos').textContent = '';
                    document.getElementById('checkins-hoje').textContent = '';
                }

                // Checkins recentes
                const recentCheckinsList = document.getElementById('recent-checkins-list');
                recentCheckinsList.innerHTML = '';
                if (recentCheckinsData.success && recentCheckinsData.data.length > 0) {
                    recentCheckinsData.data.forEach(c => {
                        const li = document.createElement('li');
                        li.className = 'py-2';
                        li.textContent = `${c.cliente_nome} - ${new Date(c.data_checkin).toLocaleDateString()}`;
                        recentCheckinsList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'py-2';
                    li.textContent = 'Nenhum checkin recente.';
                    recentCheckinsList.appendChild(li);
                }

                // Top clientes
                const topClientesList = document.getElementById('top-clientes-list');
                topClientesList.innerHTML = '';
                if (topClientesData.success && topClientesData.data.length > 0) {
                    topClientesData.data.forEach(c => {
                        const li = document.createElement('li');
                        li.className = 'py-2';
                        li.textContent = `${c.nome} - ${c.pontos} pontos`;
                        topClientesList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'py-2';
                    li.textContent = 'Nenhum cliente para exibir.';
                    topClientesList.appendChild(li);
                }

            } catch (error) {
                const welcomeMsg = document.getElementById('welcome-message');
                welcomeMsg.textContent = 'Erro ao carregar dashboard.';
                document.getElementById('total-clientes').textContent = '';
                document.getElementById('pontos-distribuidos').textContent = '';
                document.getElementById('qrcodes-ativos').textContent = '';
                document.getElementById('checkins-hoje').textContent = '';
                document.getElementById('recent-checkins-list').textContent = '';
                document.getElementById('top-clientes-list').textContent = '';
                console.error(error);
            }
        }

        loadDashboard();
    </script>
</body>
</html>
