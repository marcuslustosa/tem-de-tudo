<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresas - Tem de Tudo</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #1a1a2e; color: #fff; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; }
        .header h1 { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .header p { font-size: 13px; opacity: 0.9; }
        .search-section { padding: 16px 20px; background: #1a1a2e; }
        .search-box { position: relative; }
        .search-box input { width: 100%; padding: 14px 16px 14px 48px; background: #2a2a3e; border: 1px solid rgba(102, 126, 234, 0.1); border-radius: 16px; color: #fff; font-size: 15px; outline: none; }
        .search-box input::placeholder { color: #888; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 18px; }
        .filter-section { padding: 0 20px 16px; }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip { background: #2a2a3e; border: 1px solid rgba(102, 126, 234, 0.2); padding: 10px 18px; border-radius: 24px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.3s; }
        .filter-chip.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; }
        .filter-chip:active { transform: scale(0.95); }
        .section { padding: 20px; }
        .section-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
        .empresas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .empresa-card { background: #2a2a3e; border-radius: 16px; overflow: hidden; text-decoration: none; color: #fff; border: 1px solid rgba(102, 126, 234, 0.1); transition: transform 0.3s; }
        .empresa-card:active { transform: scale(0.97); }
        .empresa-img { width: 100%; height: 120px; object-fit: cover; background: linear-gradient(135deg, #667eea20, #764ba220); }
        .empresa-content { padding: 12px; }
        .empresa-name { font-size: 14px; font-weight: 700; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .empresa-category { font-size: 11px; color: #888; margin-bottom: 8px; }
        .empresa-footer { display: flex; justify-content: space-between; align-items: center; }
        .empresa-distance { font-size: 11px; color: #667eea; display: flex; align-items: center; gap: 4px; }
        .empresa-pontos { background: linear-gradient(135deg, #f39c12, #e67e22); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 64px; opacity: 0.2; margin-bottom: 16px; }
        .empty-state p { color: #888; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a2e; border-top: 1px solid rgba(102, 126, 234, 0.1); display: flex; justify-content: space-around; padding: 12px 0 8px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: #888; font-size: 11px; font-weight: 500; }
        .nav-item.active { color: #667eea; }
        .nav-item i { font-size: 20px; }
    </style>
    <link rel="stylesheet" href="/css/vale-bonus-theme.css">
</head>
<body>
    <div class="header">
        <h1>Empresas Parceiras</h1>
        <p>Descubra onde acumular pontos</p>
    </div>
    <div class="search-section">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Buscar empresas..." id="searchInput">
        </div>
    </div>
    <div class="filter-section">
        <div class="filter-scroll" id="filterChips">
            <div class="filter-chip active" data-cat="todas">Todas</div>
            <div class="filter-chip" data-cat="alimentacao"> Alimentos</div>
            <div class="filter-chip" data-cat="automotivo"> Automotivo</div>
            <div class="filter-chip" data-cat="beleza"> Beleza</div>
            <div class="filter-chip" data-cat="bemestar"> Bem-estar</div>
            <div class="filter-chip" data-cat="educacao"> Educação</div>
            <div class="filter-chip" data-cat="servicos"> Serviços</div>
        </div>
    </div>
    <div class="section">
        <div class="section-title" id="sectionTitle">Todas as empresas</div>
        <div class="empresas-grid" id="empresasGrid"></div>
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-store-slash"></i>
            <p>Nenhuma empresa encontrada</p>
        </div>
    </div>
    <nav class="bottom-nav">
        <a href="/app-inicio.html" class="nav-item"><i class="fas fa-home"></i><span>Início</span></a>
        <a href="/app-buscar.html" class="nav-item active"><i class="fas fa-search"></i><span>Buscar</span></a>
        <a href="/app-meus-pontos.html" class="nav-item"><i class="fas fa-wallet"></i><span>Pontos</span></a>
        <a href="/app-promocoes.html" class="nav-item"><i class="fas fa-tags"></i><span>Promoções</span></a>
        <a href="/app-perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
    </nav>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8001' : (window.location.hostname === '127.0.0.1' ? 'http://127.0.0.1:8001' : 'https://tem-de-tudo.onrender.com');
        let todasEmpresas = [];
        let categoriaAtual = 'todas';
        const categorias = { alimentacao: ' Alimentos', automotivo: ' Automotivo', beleza: ' Beleza', bemestar: ' Bem-estar', educacao: ' Educação', servicos: ' Serviços' };
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/entrar.html'; return; }
            await carregarEmpresas();
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    categoriaAtual = chip.dataset.cat;
                    filtrarEmpresas();
                });
            });
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filtrarEmpresas(e.target.value.toLowerCase());
            });
            const urlParams = new URLSearchParams(window.location.search);
            const cat = urlParams.get('cat');
            const q = urlParams.get('q');
            if (cat) {
                const chip = document.querySelector(`[data-cat="${cat}"]`);
                if (chip) chip.click();
            }
            if (q) document.getElementById('searchInput').value = q;
        });
        async function carregarEmpresas() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/cliente/empresas`, { 
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json' 
                    } 
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Mapear os dados da API para o formato esperado pelo frontend
                    todasEmpresas = data.data.map(emp => ({
                        id: emp.id,
                        nome: emp.nome,
                        categoria: emp.ramo,
                        logo: emp.logo,
                        descricao: emp.descricao,
                        pontos_por_checkin: Math.round(10 * (emp.pontos_cliente || 1))
                    }));
                } else {
                    throw new Error('Nenhuma empresa disponível');
                }
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                alert('Erro ao carregar empresas. Verifique sua conexão.');
                todasEmpresas = [];
            }
            
            renderizarEmpresas(todasEmpresas);
        }
        function filtrarEmpresas(termo = '') {
            let filtradas = todasEmpresas;
            if (categoriaAtual !== 'todas') {
                filtradas = filtradas.filter(emp => emp.categoria === categoriaAtual);
            }
            if (termo) {
                filtradas = filtradas.filter(emp => 
                    emp.nome.toLowerCase().includes(termo) || 
                    (emp.descricao && emp.descricao.toLowerCase().includes(termo))
                );
            }
            document.getElementById('sectionTitle').textContent = 
                categoriaAtual === 'todas' ? 'Todas as empresas' : categorias[categoriaAtual] || categoriaAtual;
            renderizarEmpresas(filtradas);
        }
        function renderizarEmpresas(empresas) {
            const grid = document.getElementById('empresasGrid');
            const empty = document.getElementById('emptyState');
            if (empresas.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            grid.style.display = 'grid';
            empty.style.display = 'none';
            grid.innerHTML = empresas.map(emp => `
                <a href="/app-empresa.html?id=${emp.id}" class="empresa-card">
                    <img src="${emp.logo || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400'}" alt="${emp.nome}" class="empresa-img">
                    <div class="empresa-content">
                        <div class="empresa-name">${emp.nome}</div>
                        <div class="empresa-category">${categorias[emp.categoria] || ' Outros'}</div>
                        <div class="empresa-footer">
                            <div class="empresa-distance"><i class="fas fa-map-marker-alt"></i>${Math.floor(Math.random() * 5) + 1} km</div>
                            <div class="empresa-pontos">+${emp.pontos_por_checkin || 10} pts</div>
                        </div>
                    </div>
                </a>
            `).join('');
        }
    </script>
</body>
</html>
