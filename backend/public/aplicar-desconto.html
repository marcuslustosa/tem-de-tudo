<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicar Desconto - Sistema de Pontos</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/modern-theme.css">
    
    <style>
        .search-customer {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem;
            border-radius: var(--radius-2xl);
            margin-bottom: 2rem;
        }
        
        .customer-info {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            border: 3px solid var(--success-green);
            margin: 2rem 0;
        }
        
        .points-display {
            text-align: center;
            background: var(--success-50);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 1rem 0;
        }
        
        .discount-option {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .discount-option:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 4px 12px rgba(76, 29, 149, 0.1);
        }
        
        .discount-option.selected {
            border-color: var(--success-green);
            background: var(--success-50);
        }
        
        .purchase-calculator {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .final-amount {
            background: var(--gradient-success);
            color: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            text-align: center;
            margin: 2rem 0;
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .keypad-button {
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--gray-100);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .keypad-button:hover {
            background: var(--primary-purple);
            color: white;
        }
        
        .keypad-button.clear {
            background: var(--error-red);
            color: white;
        }
        
        .keypad-button.enter {
            background: var(--success-green);
            color: white;
            grid-column: span 2;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header Simplificado -->
        <header style="background: var(--primary-purple); color: white; padding: 1rem 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
                <h2 style="margin: 0;"><i class="fas fa-percent"></i> Sistema de Descontos</h2>
                <div style="font-size: 0.875rem;">
                    <i class="fas fa-store"></i> Restaurante Premium
                </div>
            </div>
        </header>

        <main style="padding: 2rem; max-width: 800px; margin: 0 auto;">
            
            <!-- Buscar Cliente -->
            <div class="search-customer">
                <h3 style="margin-bottom: 1.5rem; text-align: center;">
                    <i class="fas fa-search"></i> Buscar Cliente
                </h3>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input 
                        type="text" 
                        id="customer-search" 
                        class="form-control" 
                        placeholder="Digite CPF, telefone ou email do cliente..."
                        style="flex: 1; font-size: 1.125rem; padding: 1rem;"
                        onkeyup="handleSearchKeyup(event)"
                    >
                    <button class="btn btn-accent btn-lg" onclick="searchCustomer()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 1rem; font-size: 0.875rem; opacity: 0.9;">
                    Digite pelo menos 3 caracteres para buscar
                </div>
            </div>

            <!-- Informa√ß√µes do Cliente (Hidden por padr√£o) -->
            <div id="customer-info" class="customer-info" style="display: none;">
                <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 2rem; align-items: center;">
                    <div>
                        <div style="width: 80px; height: 80px; background: var(--success-green); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="font-size: 2rem; color: white;"></i>
                        </div>
                    </div>
                    
                    <div>
                        <h4 id="customer-name" style="margin-bottom: 0.5rem; color: var(--gray-900);">Jo√£o Silva</h4>
                        <p id="customer-contact" style="margin: 0; color: var(--gray-600);">joao@email.com ‚Ä¢ (11) 99999-9999</p>
                    </div>
                    
                    <div class="points-display" style="margin: 0;">
                        <div id="customer-points" style="font-size: 2.5rem; font-weight: 800; color: var(--success-green);">1250</div>
                        <div style="color: var(--success-700);">pontos dispon√≠veis</div>
                    </div>
                </div>
            </div>

            <!-- Op√ß√µes de Desconto (Hidden por padr√£o) -->
            <div id="discount-options" style="display: none;">
                <h4 style="margin-bottom: 1.5rem; text-align: center; color: var(--primary-purple);">
                    <i class="fas fa-gift"></i> Descontos Dispon√≠veis
                </h4>
                
                <div id="discount-levels-container">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>

            <!-- Calculadora de Compra (Hidden por padr√£o) -->
            <div id="purchase-calculator" class="purchase-calculator" style="display: none;">
                <h4 style="margin-bottom: 1.5rem; text-align: center; color: var(--primary-purple);">
                    <i class="fas fa-calculator"></i> Calcular Desconto
                </h4>
                
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label">Valor da Compra:</label>
                    <input 
                        type="text" 
                        id="purchase-amount" 
                        class="form-control" 
                        placeholder="R$ 0,00"
                        style="font-size: 1.5rem; text-align: center; padding: 1rem;"
                        readonly
                    >
                </div>

                <!-- Teclado Num√©rico -->
                <div class="keypad">
                    <button class="keypad-button" onclick="addDigit('1')">1</button>
                    <button class="keypad-button" onclick="addDigit('2')">2</button>
                    <button class="keypad-button" onclick="addDigit('3')">3</button>
                    <button class="keypad-button" onclick="addDigit('4')">4</button>
                    <button class="keypad-button" onclick="addDigit('5')">5</button>
                    <button class="keypad-button" onclick="addDigit('6')">6</button>
                    <button class="keypad-button" onclick="addDigit('7')">7</button>
                    <button class="keypad-button" onclick="addDigit('8')">8</button>
                    <button class="keypad-button" onclick="addDigit('9')">9</button>
                    <button class="keypad-button clear" onclick="clearAmount()">C</button>
                    <button class="keypad-button" onclick="addDigit('0')">0</button>
                    <button class="keypad-button" onclick="addDecimal()">.</button>
                </div>
                
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn btn-primary btn-lg" onclick="calculateDiscount()">
                        <i class="fas fa-calculator"></i> Calcular Desconto
                    </button>
                </div>
            </div>

            <!-- Resumo Final (Hidden por padr√£o) -->
            <div id="final-summary" style="display: none;">
                <div class="final-amount">
                    <h3 style="margin-bottom: 1rem;">üí∞ Resumo da Compra</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; text-align: center;">
                        <div>
                            <div style="font-size: 1.125rem; opacity: 0.9;">Valor Original:</div>
                            <div id="original-amount" style="font-size: 1.5rem; font-weight: 700;">R$ 100,00</div>
                        </div>
                        <div>
                            <div style="font-size: 1.125rem; opacity: 0.9;">Desconto:</div>
                            <div id="discount-amount" style="font-size: 1.5rem; font-weight: 700;">- R$ 10,00</div>
                        </div>
                        <div>
                            <div style="font-size: 1.125rem; opacity: 0.9;">Total a Pagar:</div>
                            <div id="final-amount-display" style="font-size: 2rem; font-weight: 800;">R$ 90,00</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid rgba(255,255,255,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Pontos que ser√£o gastos:</div>
                                <div id="points-to-spend" style="font-size: 1.25rem; font-weight: 600;">1000 pontos</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Pontos restantes:</div>
                                <div id="remaining-points" style="font-size: 1.25rem; font-weight: 600;">250 pontos</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-outline btn-lg" onclick="cancelTransaction()" style="margin-right: 1rem;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-success btn-xl" onclick="confirmDiscount()">
                        <i class="fas fa-check"></i> Confirmar Desconto
                    </button>
                </div>
            </div>

            <!-- Bot√£o Reset -->
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-outline" onclick="resetInterface()">
                    <i class="fas fa-refresh"></i> Nova Consulta
                </button>
            </div>
        </main>
    </div>

    <script>
        let currentCustomer = null;
        let selectedDiscount = null;
        let purchaseAmount = '';

        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                searchCustomer();
            }
        }

        async function searchCustomer() {
            const search = document.getElementById('customer-search').value.trim();
            
            if (search.length < 3) {
                alert('Digite pelo menos 3 caracteres para buscar');
                return;
            }

            try {
                // Fazer chamada para a API real
                const response = await fetch('/api/discounts/find-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    },
                    body: JSON.stringify({
                        search: search,
                        empresa_id: 1 // Pegar da sess√£o ou contexto
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    alert(result.message || 'Cliente n√£o encontrado');
                    return;
                }

                // Transformar dados da API para o formato esperado
                const customer = {
                    id: result.data.customer.id,
                    name: result.data.customer.name,
                    email: result.data.customer.email,
                    phone: result.data.customer.phone,
                    points: result.data.points,
                    available_discount: result.data.available_discount,
                    next_level: result.data.next_level
                };

                showCustomerInfo(customer);

            } catch (error) {
                alert('Erro ao buscar cliente: ' + error.message);
            }
        }

        function showCustomerInfo(customer) {
            currentCustomer = customer;
            
            // Preencher informa√ß√µes do cliente
            document.getElementById('customer-name').textContent = customer.name;
            document.getElementById('customer-contact').textContent = `${customer.email} ‚Ä¢ ${customer.phone}`;
            document.getElementById('customer-points').textContent = customer.points.toLocaleString('pt-BR');
            
            // Mostrar se√ß√£o
            document.getElementById('customer-info').style.display = 'block';
            
            // Mostrar op√ß√µes de desconto
            showDiscountOptions(customer);
        }

        function showDiscountOptions(customer) {
            const container = document.getElementById('discount-levels-container');
            container.innerHTML = '';

            if (customer.available_discount) {
                const discountOption = document.createElement('div');
                discountOption.className = 'discount-option';
                discountOption.onclick = () => selectDiscount(customer.available_discount);
                
                discountOption.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h5 style="margin-bottom: 0.5rem; color: var(--success-green);">
                                ‚úÖ ${customer.available_discount.title} - ${customer.available_discount.percentage}% de desconto
                            </h5>
                            <p style="margin: 0; color: var(--gray-600);">
                                Dispon√≠vel com ${customer.available_discount.points_required.toLocaleString('pt-BR')} pontos
                            </p>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success-green);">
                                ${customer.available_discount.percentage}%
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(discountOption);
            }

            if (customer.next_level) {
                const nextLevelInfo = document.createElement('div');
                nextLevelInfo.style.cssText = `
                    background: var(--blue-50);
                    border: 2px solid var(--blue-200);
                    border-radius: var(--radius-lg);
                    padding: 1rem;
                    text-align: center;
                `;
                
                nextLevelInfo.innerHTML = `
                    <div style="color: var(--blue-700);">
                        <strong>Pr√≥ximo n√≠vel:</strong> ${customer.next_level.title} (${customer.next_level.percentage}%)<br>
                        <small>Faltam apenas ${customer.next_level.points_needed.toLocaleString('pt-BR')} pontos!</small>
                    </div>
                `;
                
                container.appendChild(nextLevelInfo);
            }

            document.getElementById('discount-options').style.display = 'block';
        }

        function selectDiscount(discount) {
            selectedDiscount = discount;
            
            // Marcar como selecionado
            document.querySelectorAll('.discount-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Mostrar calculadora
            document.getElementById('purchase-calculator').style.display = 'block';
            document.getElementById('purchase-calculator').scrollIntoView({ behavior: 'smooth' });
        }

        function addDigit(digit) {
            if (purchaseAmount.replace(/[^\d]/g, '').length < 8) {
                purchaseAmount += digit;
                updateAmountDisplay();
            }
        }

        function addDecimal() {
            if (!purchaseAmount.includes(',')) {
                purchaseAmount += purchaseAmount ? ',' : '0,';
                updateAmountDisplay();
            }
        }

        function clearAmount() {
            purchaseAmount = '';
            updateAmountDisplay();
        }

        function updateAmountDisplay() {
            const formatted = purchaseAmount ? `R$ ${purchaseAmount}` : 'R$ 0,00';
            document.getElementById('purchase-amount').value = formatted;
        }

        function calculateDiscount() {
            if (!purchaseAmount || !selectedDiscount) {
                alert('Digite o valor da compra e selecione um desconto');
                return;
            }

            const value = parseFloat(purchaseAmount.replace(',', '.')) || 0;
            
            if (value <= 0) {
                alert('Digite um valor v√°lido para a compra');
                return;
            }

            const discountAmount = value * (selectedDiscount.percentage / 100);
            const finalAmount = value - discountAmount;

            // Preencher resumo
            document.getElementById('original-amount').textContent = `R$ ${value.toFixed(2).replace('.', ',')}`;
            document.getElementById('discount-amount').textContent = `- R$ ${discountAmount.toFixed(2).replace('.', ',')}`;
            document.getElementById('final-amount-display').textContent = `R$ ${finalAmount.toFixed(2).replace('.', ',')}`;
            document.getElementById('points-to-spend').textContent = `${selectedDiscount.points_required.toLocaleString('pt-BR')} pontos`;
            document.getElementById('remaining-points').textContent = `${(currentCustomer.points - selectedDiscount.points_required).toLocaleString('pt-BR')} pontos`;

            // Mostrar resumo
            document.getElementById('final-summary').style.display = 'block';
            document.getElementById('final-summary').scrollIntoView({ behavior: 'smooth' });
        }

        async function confirmDiscount() {
            try {
                if (!confirm('Confirmar aplica√ß√£o do desconto?')) {
                    return;
                }

                const value = parseFloat(purchaseAmount.replace(',', '.')) || 0;

                // Aplicar desconto via API
                const response = await fetch('/api/discounts/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    },
                    body: JSON.stringify({
                        user_id: currentCustomer.id,
                        empresa_id: 1, // Pegar da sess√£o
                        discount_level_id: selectedDiscount.id,
                        purchase_amount: value,
                        points_to_spend: selectedDiscount.points_required
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    alert('Erro: ' + result.message);
                    return;
                }

                alert('‚úÖ Desconto aplicado com sucesso!\n\n' + 
                      `Valor original: R$ ${result.data.purchase_amount.toFixed(2)}\n` +
                      `Desconto: R$ ${result.data.discount_amount.toFixed(2)}\n` +
                      `Total final: R$ ${result.data.final_amount.toFixed(2)}\n` +
                      `Pontos gastos: ${result.data.points_spent}\n` +
                      `Pontos restantes: ${result.data.remaining_points}`);
                
                resetInterface();

            } catch (error) {
                alert('Erro ao aplicar desconto: ' + error.message);
            }
        }

        function cancelTransaction() {
            if (confirm('Cancelar esta transa√ß√£o?')) {
                document.getElementById('final-summary').style.display = 'none';
                clearAmount();
            }
        }

        function resetInterface() {
            currentCustomer = null;
            selectedDiscount = null;
            purchaseAmount = '';
            
            document.getElementById('customer-search').value = '';
            document.getElementById('customer-info').style.display = 'none';
            document.getElementById('discount-options').style.display = 'none';
            document.getElementById('purchase-calculator').style.display = 'none';
            document.getElementById('final-summary').style.display = 'none';
            
            updateAmountDisplay();
            document.getElementById('customer-search').focus();
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('customer-search').focus();
        });
    </script>
</body>
</html>