<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresas Parceiras - Tem de Tudo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/theme-escuro.css">
    
    <style>
        body {
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
            padding: var(--space-6) var(--space-4);
            color: white;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: var(--space-2);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .search-section {
            padding: var(--space-4);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 48px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            color: var(--text-primary);
            font-size: 15px;
        }
        
        .search-box input:focus {
            border-color: var(--purple-1);
            outline: none;
        }
        
        .search-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: var(--space-4);
            scrollbar-width: none;
            background: var(--bg-primary);
        }
        
        .categories::-webkit-scrollbar {
            display: none;
        }
        
        .category-chip {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-chip:hover,
        .category-chip.active {
            background: var(--purple-1);
            color: white;
            border-color: var(--purple-1);
        }
        
        .empresas-list {
            padding: var(--space-4);
        }
        
        .empresa-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--space-4);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .empresa-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .empresa-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
        }
        
        .empresa-content {
            padding: var(--space-4);
        }
        
        .empresa-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-3);
        }
        
        .empresa-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .empresa-category {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .empresa-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }
        
        .empresa-stats {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border-color);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .stat-item i {
            color: var(--purple-1);
        }
        
        .empresa-promo {
            background: rgba(102, 126, 234, 0.08);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
        }
        
        .promo-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--purple-1);
            margin-bottom: 4px;
        }
        
        .promo-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .empresa-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .btn-primary {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, var(--purple-1), var(--purple-2));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-outline {
            flex: 1;
            padding: 12px;
            background: transparent;
            color: var(--purple-1);
            border: 1px solid var(--purple-1);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-store"></i> Empresas Parceiras</h1>
        <p>Descubra empresas e ganhe b√¥nus!</p>
    </div>
    
    <div class="search-section">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar empresas..." oninput="filtrarEmpresas()">
        </div>
    </div>
    
    <div class="categories">
        <div class="category-chip active" onclick="filtrarCategoria('todas')">
            <i class="fas fa-th"></i> Todas
        </div>
        <div class="category-chip" onclick="filtrarCategoria('alimentacao')">
            <i class="fas fa-utensils"></i> Alimenta√ß√£o
        </div>
        <div class="category-chip" onclick="filtrarCategoria('moda')">
            <i class="fas fa-tshirt"></i> Moda
        </div>
        <div class="category-chip" onclick="filtrarCategoria('saude')">
            <i class="fas fa-heartbeat"></i> Sa√∫de
        </div>
        <div class="category-chip" onclick="filtrarCategoria('beleza')">
            <i class="fas fa-cut"></i> Beleza
        </div>
        <div class="category-chip" onclick="filtrarCategoria('servicos')">
            <i class="fas fa-tools"></i> Servi√ßos
        </div>
    </div>
    
    <div class="empresas-list" id="empresasList">
        <!-- Empresas ser√£o carregadas aqui via JavaScript -->
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/dashboard-cliente.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>In√≠cio</span>
        </a>
        <a href="/app-empresas.html" class="nav-item active">
            <i class="fas fa-store"></i>
            <span>Empresas</span>
        </a>
        <a href="/app-promocoes.html" class="nav-item">
            <i class="fas fa-tags"></i>
            <span>Promo√ß√µes</span>
        </a>
        <a href="/app-qrcode.html" class="nav-item">
            <i class="fas fa-qrcode"></i>
            <span>Meu QR</span>
        </a>
        <a href="/app-perfil-cliente.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Perfil</span>
        </a>
    </nav>
    
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 
            'http://localhost:8000' : 
            'https://tem-de-tudo.onrender.com';
        
        let todasEmpresas = [];
        let categoriaAtual = 'todas';
        let empresasFiltradas = [];
        
        // Carrega empresas da API ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            carregarEmpresasAPI();
        });

        async function carregarEmpresasAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/empresas`);
                const data = await response.json();
                
                if (data.success) {
                    todasEmpresas = data.data.empresas.map(emp => ({
                        id: emp.id,
                        nome: emp.nome,
                        categoria: emp.categoria || 'servicos',
                        descricao: emp.descricao || '',
                        imagem: emp.logo || 'https://via.placeholder.com/800x400/667eea/ffffff',
                        pontos_checkin: emp.pontos_checkin || 10,
                        total_clientes: Math.floor(Math.random() * 5000), // Tempor√°rio
                        avaliacoes: (4.5 + Math.random() * 0.5).toFixed(1),
                        aberto: true,
                        promocao: null // Pode buscar promo√ß√µes depois
                    }));
                    empresasFiltradas = todasEmpresas;
                    renderizarEmpresas(empresasFiltradas);
                } else {
                    console.error('Erro ao carregar empresas:', data.message);
                    mostrarErro('N√£o foi poss√≠vel carregar as empresas');
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                // Fallback para dados fict√≠cios em caso de erro
                carregarDadosFicticios();
            }
        }

        function carregarDadosFicticios() {
            // Dados de fallback
            todasEmpresas = [
                {
                    id: 1,
                    nome: 'Restaurante Sabor & Arte',
                    categoria: 'alimentacao',
                    descricao: 'Culin√°ria brasileira contempor√¢nea',
                    imagem: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800',
                    pontos_checkin: 10,
                    total_clientes: 1247,
                    avaliacoes: 4.8,
                    aberto: true,
                    promocao: {
                        titulo: 'üéâ Desconto de 20% no almo√ßo',
                        descricao: 'V√°lido de segunda a sexta at√© 15h'
                    }
                },
                {
                    id: 2,
                    nome: 'Pizzaria Bella Napoli',
                    categoria: 'alimentacao',
                    descricao: 'Pizzas artesanais no forno a lenha',
                    imagem: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=800',
                    pontos_checkin: 15,
                    total_clientes: 2893,
                    avaliacoes: 4.9,
                    aberto: true,
                    promocao: {
                        titulo: 'üçï Compre 1 leve 2 √†s ter√ßas',
                        descricao: 'Pizza grande na compra de qualquer tamanho'
                    }
                }
            ];
            empresasFiltradas = todasEmpresas;
            renderizarEmpresas(empresasFiltradas);
        }

        function mostrarErro(mensagem) {
            const container = document.getElementById('empresasList');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${mensagem}</p>
                    <button class="btn-primary" onclick="carregarEmpresasAPI()">
                        <i class="fas fa-redo"></i> Tentar novamente
                    </button>
                </div>
            `;
        }
        
        function renderizarEmpresas(empresas) {
            const container = document.getElementById('empresasList');
            
            if (empresas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Nenhuma empresa encontrada</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = empresas.map(empresa => `
                <div class="empresa-card" onclick="abrirEmpresa(${empresa.id})">
                    <img src="${empresa.imagem}" alt="${empresa.nome}" class="empresa-image" onerror="this.src='https://via.placeholder.com/800x400/667eea/ffffff?text=${encodeURIComponent(empresa.nome)}'">
                    
                    <div class="empresa-content">
                        <div class="empresa-header">
                            <div>
                                <div class="empresa-name">${empresa.nome}</div>
                                <div class="empresa-category">
                                    <i class="fas ${getCategoriaIcon(empresa.categoria)}"></i>
                                    ${getCategoriaLabel(empresa.categoria)}
                                </div>
                            </div>
                            ${empresa.aberto ? '<span class="empresa-badge">Aberto</span>' : ''}
                        </div>
                        
                        <div class="empresa-stats">
                            <div class="stat-item">
                                <i class="fas fa-star"></i>
                                ${empresa.avaliacoes}
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-users"></i>
                                ${formatarNumero(empresa.total_clientes)} clientes
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-coins"></i>
                                +${empresa.pontos_checkin} pontos
                            </div>
                        </div>
                        
                        ${empresa.promocao ? `
                        <div class="empresa-promo">
                            <div class="promo-title">${empresa.promocao.titulo}</div>
                            <div class="promo-desc">${empresa.promocao.descricao}</div>
                        </div>
                        ` : ''}
                        
                        <div class="empresa-actions">
                            <button class="btn-primary" onclick="event.stopPropagation(); fazerCheckin(${empresa.id})">
                                <i class="fas fa-qrcode"></i> Check-in
                            </button>
                            <button class="btn-outline" onclick="event.stopPropagation(); verPromocoes(${empresa.id})">
                                <i class="fas fa-tags"></i> Promo√ß√µes
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filtrarEmpresas() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            
            empresasFiltradas = todasEmpresas.filter(empresa => {
                const matchCategoria = categoriaAtual === 'todas' || empresa.categoria === categoriaAtual;
                const matchBusca = termo === '' || 
                    empresa.nome.toLowerCase().includes(termo) ||
                    empresa.descricao.toLowerCase().includes(termo);
                
                return matchCategoria && matchBusca;
            });
            
            renderizarEmpresas(empresasFiltradas);
        }
        
        function filtrarCategoria(categoria) {
            categoriaAtual = categoria;
            
            // Atualiza visual dos chips
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.closest('.category-chip').classList.add('active');
            
            filtrarEmpresas();
        }
        
        function getCategoriaIcon(categoria) {
            const icons = {
                'alimentacao': 'fa-utensils',
                'moda': 'fa-tshirt',
                'saude': 'fa-heartbeat',
                'beleza': 'fa-cut',
                'servicos': 'fa-tools'
            };
            return icons[categoria] || 'fa-store';
        }
        
        function getCategoriaLabel(categoria) {
            const labels = {
                'alimentacao': 'Alimenta√ß√£o',
                'moda': 'Moda',
                'saude': 'Sa√∫de',
                'beleza': 'Beleza',
                'servicos': 'Servi√ßos'
            };
            return labels[categoria] || 'Outros';
        }
        
        function formatarNumero(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num;
        }
        
        function abrirEmpresa(id) {
            window.location.href = `/app-empresa-detalhes.html?id=${id}`;
        }
        
        async function fazerCheckin(id) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('‚ùå Voc√™ precisa estar logado para fazer check-in');
                    window.location.href = '/entrar.html';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/checkins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        empresa_id: id,
                        latitude: -23.550520,
                        longitude: -46.633308,
                        metodo: 'manual'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Check-in realizado!\n\nVoc√™ ganhou +${data.data.pontos_ganhos} pontos! üéâ\nTotal: ${data.data.pontos_totais} pontos`);
                    
                    // Adiciona notifica√ß√£o
                    if (window.NotificationSystem) {
                        NotificationSystem.add({
                            title: '‚úÖ Check-in Realizado!',
                            message: `Voc√™ ganhou ${data.data.pontos_ganhos} pontos`,
                            icon: 'fa-check-circle',
                            type: 'success'
                        });
                    }
                } else {
                    alert('‚ùå Erro ao fazer check-in: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao fazer check-in. Tente novamente.');
            }
        }
        
        function verPromocoes(id) {
            window.location.href = `/app-promocoes.html?empresa=${id}`;
        }
    </script>
</body>
</html>
