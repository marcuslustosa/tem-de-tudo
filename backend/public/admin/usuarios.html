<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usuários - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/app-unified.css">
    <link rel="stylesheet" href="/css/modern-theme.css">
    <link rel="stylesheet" href="/css/temdetudo-theme.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-container">
                <a href="/admin.html" class="logo">
                    <img src="/img/logo.png" alt="Tem de Tudo" class="logo-image">
                    <span>Tem de Tudo</span>
                </a>
                <nav class="nav-menu">
                    <a href="/admin.html"><i class="fas fa-home icon-sm"></i> Dashboard</a>
                    <a href="/admin/usuarios.html" class="active"><i class="fas fa-users icon-sm"></i> Usuários</a>
                    <a href="/admin/empresas.html"><i class="fas fa-building icon-sm"></i> Empresas</a>
                    <a href="/admin/relatorios.html"><i class="fas fa-chart-bar icon-sm"></i> Relatórios</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt icon-sm"></i> Sair</a>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <div style="max-width: 1400px; margin: 0 auto; padding: var(--space-6);">
                <!-- Page Header -->
                <div class="glass-container" style="margin-bottom: var(--space-6);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="margin: 0; font-size: 1.75rem; color: var(--gray-900);">
                                <i class="fas fa-users"></i> Gerenciar Usuários
                            </h1>
                            <p style="margin: 0.5rem 0 0; color: var(--gray-600);">
                                Cadastrar, editar e excluir clientes e administradores
                            </p>
                        </div>
                        <button onclick="openCreateModal()" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Novo Usuário
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-4" style="gap: var(--space-4); margin-bottom: var(--space-6);">
                    <div class="stat-card">
                        <i class="fas fa-users" style="font-size: 2rem; color: var(--primary-purple);"></i>
                        <div class="stat-value" id="totalUsuarios">0</div>
                        <div class="stat-label">Total Usuários</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-shield" style="font-size: 2rem; color: var(--accent-orange);"></i>
                        <div class="stat-value" id="totalAdmins">0</div>
                        <div class="stat-label">Administradores</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-tie" style="font-size: 2rem; color: var(--accent-green);"></i>
                        <div class="stat-value" id="totalEmpresas">0</div>
                        <div class="stat-label">Empresas</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user" style="font-size: 2rem; color: var(--accent-pink);"></i>
                        <div class="stat-value" id="totalClientes">0</div>
                        <div class="stat-label">Clientes</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: var(--space-6);">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
                            <input type="text" id="searchInput" class="form-control" placeholder="🔍 Buscar usuário..." oninput="filterUsuarios()">
                            
                            <select id="tipoFilter" class="form-control" onchange="filterUsuarios()">
                                <option value="">Todos os Tipos</option>
                                <option value="admin">Administradores</option>
                                <option value="empresa">Empresas</option>
                                <option value="cliente">Clientes</option>
                            </select>

                            <select id="statusFilter" class="form-control" onchange="filterUsuarios()">
                                <option value="">Todos os Status</option>
                                <option value="ativo">Ativos</option>
                                <option value="inativo">Inativos</option>
                                <option value="bloqueado">Bloqueados</option>
                            </select>

                            <button onclick="resetFilters()" class="btn btn-outline">
                                <i class="fas fa-sync"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-body">
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Avatar</th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th>Pontos</th>
                                        <th>Cadastro</th>
                                        <th>Último Acesso</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="usuariosTableBody">
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: var(--space-8);">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                            <p style="margin-top: var(--space-4); color: var(--gray-500);">Carregando usuários...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Criar/Editar Usuário -->
    <div id="usuarioModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="modalTitle"><i class="fas fa-user-plus"></i> Novo Usuário</h2>
                <button onclick="closeModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="usuarioForm" onsubmit="saveUsuario(event)">
                    <input type="hidden" id="usuarioId">
                    
                    <div class="grid grid-cols-2" style="gap: var(--space-4);">
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" id="nome" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">CPF/CNPJ</label>
                            <input type="text" id="cpf" class="form-control" placeholder="000.000.000-00">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="tel" id="telefone" class="form-control" placeholder="(00) 00000-0000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tipo de Usuário *</label>
                            <select id="tipo" class="form-control" required onchange="handleTipoChange()">
                                <option value="">Selecione...</option>
                                <option value="cliente">Cliente</option>
                                <option value="empresa">Empresa</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>

                        <div class="form-group" id="senhaGroup">
                            <label class="form-label">Senha <span id="senhaRequired">*</span></label>
                            <input type="password" id="senha" class="form-control" placeholder="Mínimo 6 caracteres">
                            <small style="color: var(--gray-500); font-size: 0.75rem;">Deixe em branco para manter a senha atual</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select id="status" class="form-control" required>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                                <option value="bloqueado">Bloqueado</option>
                            </select>
                        </div>

                        <!-- Campos específicos para cliente -->
                        <div class="form-group cliente-only" style="display: none;">
                            <label class="form-label">Pontos</label>
                            <input type="number" id="pontos" class="form-control" value="0" min="0">
                        </div>

                        <div class="form-group cliente-only" style="display: none;">
                            <label class="form-label">Nível</label>
                            <select id="nivel" class="form-control">
                                <option value="bronze">Bronze</option>
                                <option value="prata">Prata</option>
                                <option value="ouro">Ouro</option>
                                <option value="platina">Platina</option>
                                <option value="diamante">Diamante</option>
                            </select>
                        </div>

                        <!-- Campos específicos para admin -->
                        <div class="form-group admin-only" style="display: none; grid-column: span 2;">
                            <label class="form-label">Permissões</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-2);">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" class="permissao-check" value="gerenciar_usuarios">
                                    <span>Gerenciar Usuários</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" class="permissao-check" value="gerenciar_empresas">
                                    <span>Gerenciar Empresas</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" class="permissao-check" value="visualizar_relatorios">
                                    <span>Visualizar Relatórios</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" class="permissao-check" value="configuracoes_sistema">
                                    <span>Configurações do Sistema</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-6);">
                        <button type="button" onclick="closeModal()" class="btn btn-outline">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Usuário
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script>
        let usuarios = [];
        let filteredUsuarios = [];
        let editingId = null;

        // Verificar autenticação
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '/admin-login.html';
                return false;
            }
            return token;
        }

        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin-login.html';
        }

        // Carregar usuários
        async function loadUsuarios() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_CONFIG.getBaseURL()}/api/admin/usuarios`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    usuarios = result.data || result.usuarios || result;
                    filteredUsuarios = [...usuarios];
                    updateStats();
                    renderUsuarios();
                } else {
                    throw new Error('Erro ao carregar usuários');
                }
            } catch (error) {
                console.error('Erro:', error);
                showEmptyState();
            }
        }

        // Atualizar estatísticas
        function updateStats() {
            document.getElementById('totalUsuarios').textContent = usuarios.length;
            document.getElementById('totalAdmins').textContent = usuarios.filter(u => u.tipo === 'admin' || u.role === 'admin').length;
            document.getElementById('totalEmpresas').textContent = usuarios.filter(u => u.tipo === 'empresa' || u.role === 'empresa').length;
            document.getElementById('totalClientes').textContent = usuarios.filter(u => u.tipo === 'cliente' || u.role === 'cliente' || !u.tipo).length;
        }

        // Renderizar tabela
        function renderUsuarios() {
            const tbody = document.getElementById('usuariosTableBody');
            
            if (filteredUsuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: var(--space-8);">
                            <i class="fas fa-users" style="font-size: 3rem; color: var(--gray-300);"></i>
                            <p style="margin-top: var(--space-4); color: var(--gray-500);">Nenhum usuário encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredUsuarios.map(user => {
                const tipo = user.tipo || user.role || 'cliente';
                const tipoColors = {
                    'admin': 'danger',
                    'empresa': 'warning',
                    'cliente': 'info'
                };
                const statusColors = {
                    'ativo': 'success',
                    'inativo': 'secondary',
                    'bloqueado': 'danger'
                };

                return `
                    <tr>
                        <td>
                            <div style="width: 48px; height: 48px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #1D1D1F; font-weight: 700; font-size: 1.25rem;">
                                ${user.nome ? user.nome.charAt(0).toUpperCase() : 'U'}
                            </div>
                        </td>
                        <td><strong>${user.nome || user.name || 'Sem nome'}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-${tipoColors[tipo]}">${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</span></td>
                        <td><span class="badge badge-${statusColors[user.status] || 'secondary'}">${user.status || 'ativo'}</span></td>
                        <td>${user.pontos || 0} pts</td>
                        <td>${new Date(user.created_at || Date.now()).toLocaleDateString('pt-BR')}</td>
                        <td>${user.ultimo_acesso ? new Date(user.ultimo_acesso).toLocaleDateString('pt-BR') : '-'}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editUsuario(${user.id})" class="btn btn-sm btn-outline" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="resetPassword(${user.id}, '${user.email}')" class="btn btn-sm btn-warning" title="Resetar Senha">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button onclick="deleteUsuario(${user.id}, '${user.nome || user.name}')" class="btn btn-sm btn-danger" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showEmptyState() {
            const tbody = document.getElementById('usuariosTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: var(--space-8);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--accent-orange);"></i>
                        <p style="margin-top: var(--space-4); color: var(--gray-600);">Erro ao carregar usuários</p>
                    </td>
                </tr>
            `;
        }

        // Filtros
        function filterUsuarios() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tipoFilter = document.getElementById('tipoFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredUsuarios = usuarios.filter(user => {
                const tipo = user.tipo || user.role || 'cliente';
                const matchesSearch = !searchTerm || 
                    (user.nome && user.nome.toLowerCase().includes(searchTerm)) ||
                    (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.cpf && user.cpf.includes(searchTerm));

                const matchesTipo = !tipoFilter || tipo === tipoFilter;
                const matchesStatus = !statusFilter || user.status === statusFilter;

                return matchesSearch && matchesTipo && matchesStatus;
            });

            renderUsuarios();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('tipoFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterUsuarios();
        }

        // Modal
        function handleTipoChange() {
            const tipo = document.getElementById('tipo').value;
            const clienteFields = document.querySelectorAll('.cliente-only');
            const adminFields = document.querySelectorAll('.admin-only');

            clienteFields.forEach(field => field.style.display = tipo === 'cliente' ? 'block' : 'none');
            adminFields.forEach(field => field.style.display = tipo === 'admin' ? 'block' : 'none');
        }

        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Novo Usuário';
            document.getElementById('usuarioForm').reset();
            document.getElementById('senhaRequired').textContent = '*';
            document.getElementById('senha').required = true;
            handleTipoChange();
            document.getElementById('usuarioModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('usuarioModal').style.display = 'none';
        }

        // Editar
        function editUsuario(id) {
            const usuario = usuarios.find(u => u.id === id);
            if (!usuario) return;

            editingId = id;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-edit"></i> Editar Usuário';
            document.getElementById('usuarioId').value = id;
            document.getElementById('nome').value = usuario.nome || usuario.name || '';
            document.getElementById('email').value = usuario.email;
            document.getElementById('cpf').value = usuario.cpf || '';
            document.getElementById('telefone').value = usuario.telefone || '';
            document.getElementById('tipo').value = usuario.tipo || usuario.role || 'cliente';
            document.getElementById('status').value = usuario.status || 'ativo';
            document.getElementById('pontos').value = usuario.pontos || 0;
            document.getElementById('nivel').value = usuario.nivel || 'bronze';
            
            document.getElementById('senhaRequired').textContent = '';
            document.getElementById('senha').required = false;
            document.getElementById('senha').value = '';

            handleTipoChange();
            document.getElementById('usuarioModal').style.display = 'flex';
        }

        // Salvar
        async function saveUsuario(event) {
            event.preventDefault();
            const token = checkAuth();
            if (!token) return;

            const formData = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                cpf: document.getElementById('cpf').value,
                telefone: document.getElementById('telefone').value,
                tipo: document.getElementById('tipo').value,
                status: document.getElementById('status').value,
                pontos: parseInt(document.getElementById('pontos').value) || 0,
                nivel: document.getElementById('nivel').value
            };

            const senha = document.getElementById('senha').value;
            if (senha) {
                formData.senha = senha;
            }

            try {
                const url = editingId 
                    ? `${API_CONFIG.getBaseURL()}/api/admin/usuarios/${editingId}`
                    : `${API_CONFIG.getBaseURL()}/api/admin/usuarios`;

                const response = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert(editingId ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!');
                    closeModal();
                    loadUsuarios();
                } else {
                    const error = await response.json();
                    alert('Erro: ' + (error.message || 'Não foi possível salvar o usuário'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar usuário. Tente novamente.');
            }
        }

        // Resetar senha
        async function resetPassword(id, email) {
            const token = checkAuth();
            if (!token) return;

            if (!confirm(`Deseja enviar email de reset de senha para ${email}?`)) return;

            try {
                const response = await fetch(`${API_CONFIG.getBaseURL()}/api/admin/usuarios/${id}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Email de reset de senha enviado com sucesso!');
                } else {
                    alert('Erro ao enviar email de reset');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao resetar senha. Tente novamente.');
            }
        }

        // Excluir
        async function deleteUsuario(id, nome) {
            const token = checkAuth();
            if (!token) return;

            if (!confirm(`Tem certeza que deseja EXCLUIR o usuário "${nome}"?\n\nEsta ação não pode ser desfeita!`)) return;

            try {
                const response = await fetch(`${API_CONFIG.getBaseURL()}/api/admin/usuarios/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Usuário excluído com sucesso!');
                    loadUsuarios();
                } else {
                    alert('Erro ao excluir usuário');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir usuário. Tente novamente.');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadUsuarios();
        });

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('usuarioModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
