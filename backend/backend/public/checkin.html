<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Tem de Tudo</title>
    
    <!-- Meta Tags PWA -->
    <meta name="description" content="Faça check-in e ganhe pontos de fidelidade">
    <meta name="theme-color" content="#4c1d95">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="/frontend/img/logo.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/modern-theme.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-container">
                <a href="/" class="logo">
                    <img src="/frontend/img/logo.png" alt="Tem de Tudo" class="logo-image">
                </a>
                
                <nav class="nav-menu">
                    <a href="/"><i class="fas fa-home" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Início</a>
                    <a href="/estabelecimentos.html"><i class="fas fa-store" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Estabelecimentos</a>
                    <a href="/checkin.html" class="active"><i class="fas fa-map-marker-alt" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Check-in</a>
                    <a href="/pontos.html"><i class="fas fa-coins" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Meus Pontos</a>
                    <a href="/contato.html"><i class="fas fa-envelope" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Contato</a>
                </nav>
                
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </header>

        <!-- Mobile Navigation -->
        <div class="mobile-nav" id="mobileNav">
            <div class="mobile-nav-menu">
                <a href="/"><i class="fas fa-home" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Início</a>
                <a href="/estabelecimentos.html"><i class="fas fa-store" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Estabelecimentos</a>
                <a href="/checkin.html" class="active"><i class="fas fa-map-marker-alt" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Check-in</a>
                <a href="/pontos.html"><i class="fas fa-coins" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Meus Pontos</a>
                <a href="/contato.html"><i class="fas fa-envelope" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Contato</a>
            </div>
        </div>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Hero Section -->
            <section style="background: var(--gradient-primary); color: white; padding: var(--space-12) var(--space-6); text-align: center;">
                <div style="max-width: 600px; margin: 0 auto;">
                    <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: var(--accent-orange); margin-bottom: 1rem; display: block;"></i>
                    <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">Fazer Check-in</h1>
                    <p style="font-size: 1.125rem; opacity: 0.9;">Ganhe pontos a cada visita! Faça check-in e comprove sua compra para acumular pontos de fidelidade.</p>
                </div>
            </section>

            <!-- Check-in Process -->
            <section style="padding: var(--space-12) var(--space-6); background: var(--gray-50);">
                <div style="max-width: 800px; margin: 0 auto;">
                    
                    <!-- Step 1: Localização -->
                    <div class="card" id="step1" style="margin-bottom: var(--space-8);">
                        <div class="card-header text-center" style="background: white; color: var(--gray-900);">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-purple); font-size: 1.5rem; margin-bottom: 1rem;"></i>
                            <h2 style="color: var(--gray-900); margin-bottom: 0.5rem;">1. Selecione o Estabelecimento</h2>
                            <p style="color: var(--gray-600);">Escolha onde você está fazendo compras para ganhar pontos</p>
                        </div>

                        <div class="card-body">
                            <!-- Busca de estabelecimentos próximos -->
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-search" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Buscar Estabelecimento
                                </label>
                                <input 
                                    type="text" 
                                    id="searchEstablishment" 
                                    class="form-control" 
                                    placeholder="Digite o nome ou busque por categoria..."
                                    onkeyup="filterEstablishments()"
                                >
                            </div>

                            <!-- Lista de estabelecimentos -->
                            <div id="establishmentsList" style="margin-top: 1rem;">
                                <div class="establishment-option" data-id="burger-house" onclick="selectEstablishment('burger-house', 'Burger House')">
                                    <div style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius-lg); margin-bottom: 0.5rem; cursor: pointer; transition: var(--transition-fast);">
                                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin-right: 1rem; flex-shrink: 0;">
                                            <img src="https://images.unsplash.com/photo-1586190848861-99aa4a171e90?w=60&h=60&fit=crop&crop=center" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div style="flex: 1;">
                                            <h4 style="margin-bottom: 0.25rem; color: var(--gray-900);">Burger House</h4>
                                            <p style="margin: 0; color: var(--gray-600); font-size: 0.875rem;">Hamburgueria • +1.5x pontos</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="background: var(--primary-purple); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem;">1.5x</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="establishment-option" data-id="fashion-store" onclick="selectEstablishment('fashion-store', 'Fashion Store')">
                                    <div style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius-lg); margin-bottom: 0.5rem; cursor: pointer; transition: var(--transition-fast);">
                                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin-right: 1rem; flex-shrink: 0;">
                                            <img src="https://images.unsplash.com/photo-1523381210434-271e8be1f52b?w=60&h=60&fit=crop&crop=center" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div style="flex: 1;">
                                            <h4 style="margin-bottom: 0.25rem; color: var(--gray-900);">Fashion Store</h4>
                                            <p style="margin: 0; color: var(--gray-600); font-size: 0.875rem;">Roupas & Acessórios • +1x pontos</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="background: var(--accent-orange); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem;">1x</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="establishment-option" data-id="farmacia-saude" onclick="selectEstablishment('farmacia-saude', 'Farmácia Saúde+')">
                                    <div style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-200); border-radius: var(--radius-lg); margin-bottom: 0.5rem; cursor: pointer; transition: var(--transition-fast);">
                                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin-right: 1rem; flex-shrink: 0;">
                                            <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=60&h=60&fit=crop&crop=center" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div style="flex: 1;">
                                            <h4 style="margin-bottom: 0.25rem; color: var(--gray-900);">Farmácia Saúde+</h4>
                                            <p style="margin: 0; color: var(--gray-600); font-size: 0.875rem;">Farmácia • +2x pontos</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <span style="background: var(--success-green); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem;">2x</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: QR Code Scanner -->
                    <div class="card" id="step2" style="display: none; margin-bottom: var(--space-8);">
                        <div class="card-header text-center" style="background: white; color: var(--gray-900);">
                            <i class="fas fa-qrcode" style="color: var(--primary-purple); font-size: 1.5rem; margin-bottom: 1rem;"></i>
                            <h2 style="color: var(--gray-900); margin-bottom: 0.5rem;">2. Escaneie o QR Code</h2>
                            <p style="color: var(--gray-600);">Escaneie o QR Code do estabelecimento para fazer seu check-in</p>
                        </div>

                        <div class="card-body">
                            <div id="selectedEstablishment" style="margin-bottom: 2rem; padding: 1rem; background: var(--primary-50); border-radius: var(--radius-lg); text-align: center;">
                                <h3 style="margin-bottom: 0.5rem; color: var(--primary-purple);">Check-in em:</h3>
                                <p style="margin: 0; font-size: 1.125rem; font-weight: 600; color: var(--gray-800);" id="establishmentName"></p>
                            </div>

                            <!-- QR Code Scanner -->
                            <div id="qr-scanner-container" class="qr-scanner-container" style="text-align: center; margin-bottom: 2rem;">
                                <!-- Status do Scanner -->
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="background: var(--gray-50); border-radius: var(--radius-lg); padding: 1.5rem; border: 2px dashed var(--gray-300);">
                                        <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--primary-purple); margin-bottom: 1rem;"></i>
                                        <h4 style="margin-bottom: 0.5rem; color: var(--gray-700);">Procure pelo QR Code</h4>
                                        <p id="qr-status" style="margin: 0; color: var(--gray-600); font-size: 0.875rem;">📱 Toque para escanear QR Code</p>
                                    </div>
                                </div>

                                <!-- Controles do Scanner -->
                                <div style="margin-bottom: 1.5rem;">
                                    <button id="start-qr-scan" class="btn btn-primary btn-lg" style="margin-right: 1rem;">
                                        <i class="fas fa-camera" style="margin-right: 0.5rem;"></i>
                                        Escanear QR Code
                                    </button>
                                    <button id="stop-qr-scan" class="btn btn-outline" style="display: none; margin-right: 1rem;">
                                        <i class="fas fa-stop" style="margin-right: 0.5rem;"></i>
                                        Parar Scanner
                                    </button>
                                    <button id="manual-qr-input" class="btn btn-outline">
                                        <i class="fas fa-keyboard" style="margin-right: 0.5rem;"></i>
                                        Digitar Código
                                    </button>
                                </div>

                                <!-- Elementos do Scanner -->
                                <video id="qr-video" style="display: none; width: 100%; max-width: 400px; border-radius: var(--radius-lg);"></video>
                                <canvas id="qr-canvas" style="display: none;"></canvas>
                                
                                <!-- Dicas para o usuário -->
                                <div style="background: var(--blue-50); border-radius: var(--radius-lg); padding: 1rem; margin-top: 1rem;">
                                    <h5 style="color: var(--blue-700); margin-bottom: 0.5rem;">
                                        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i> Como funciona:
                                    </h5>
                                    <ul style="text-align: left; color: var(--blue-600); font-size: 0.875rem; margin: 0; padding-left: 1.5rem;">
                                        <li>Procure o QR Code na mesa ou balcão</li>
                                        <li>Aponte a câmera para o código</li>
                                        <li>Aguarde a detecção automática</li>
                                        <li>Confirme seu check-in e ganhe pontos!</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Informações do Check-in via QR -->
                            <div id="qr-checkin-info" style="display: none; margin-top: 2rem;">
                                <div style="background: var(--success-50); border-radius: var(--radius-lg); padding: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
                                    <i class="fas fa-check-circle" style="color: var(--success-green); font-size: 2rem; margin-bottom: 1rem;"></i>
                                    <h4 style="color: var(--success-green); margin-bottom: 0.5rem;">QR Code Válido!</h4>
                                    <p style="margin: 0; color: var(--success-700);">Check-in será processado automaticamente</p>
                                </div>
                                
                                <div style="background: var(--gray-50); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                                        <div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-purple);" id="qr-points">0</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">Pontos Base</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-orange);" id="qr-multiplier">1x</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">Multiplicador</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ofertas ativas do QR -->
                                <div id="qr-offers" style="display: none; margin-bottom: 1.5rem;"></div>
                            </div>

                            <!-- Aguardando QR Code -->
                            <div id="waiting-qr" style="text-align: center; padding: 2rem;">
                                <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                                <h4 style="color: var(--gray-500); margin-bottom: 0.5rem;">Aguardando QR Code</h4>
                                <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">Escaneie o QR Code do estabelecimento para continuar</p>
                            </div>
                        </div>
                    </div>

                    <!-- Success Message -->
                    <div class="card" id="successMessage" style="display: none;">
                        <div class="card-body text-center">
                            <div style="width: 80px; height: 80px; background: var(--success-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                                <i class="fas fa-check" style="font-size: 2rem; color: white;"></i>
                            </div>
                            <h2 style="color: var(--success-green); margin-bottom: 1rem;">Check-in Realizado!</h2>
                            <p style="color: var(--gray-600); margin-bottom: 2rem;">Sua compra está sendo validada. Os pontos serão creditados em até 24 horas.</p>
                            
                            <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                                <div id="summaryInfo"></div>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <a href="/pontos.html" class="btn btn-primary">
                                    <i class="fas fa-coins" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Ver Meus Pontos
                                </a>
                                <button class="btn btn-outline" onclick="newCheckin()">
                                    <i class="fas fa-plus" style="font-size: 0.875rem; margin-right: 0.5rem;"></i> Novo Check-in
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; z-index: 9999; align-items: center; justify-content: center;">
        <div style="text-align: center; color: white;">
            <div style="border: 3px solid var(--primary-purple); border-top: 3px solid transparent; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <div>Processando check-in...</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/pontos-api.js"></script>
    <script src="/js/app-fixed.js"></script>
    <script src="/js/qr-scanner.js"></script>
    <script>
        let selectedEstablishmentId = null;
        let selectedEstablishmentName = null;
        let scannedQRCode = null;

        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            const btn = document.querySelector('.mobile-menu-btn');
            mobileNav.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function filterEstablishments() {
            const search = document.getElementById('searchEstablishment').value.toLowerCase();
            const options = document.querySelectorAll('.establishment-option');
            
            options.forEach(option => {
                const name = option.querySelector('h4').textContent.toLowerCase();
                const category = option.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(search) || category.includes(search)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function selectEstablishment(id, name) {
            selectedEstablishmentId = id;
            selectedEstablishmentName = name;
            
            // Remover seleção anterior
            document.querySelectorAll('.establishment-option > div').forEach(div => {
                div.style.borderColor = 'var(--gray-200)';
                div.style.background = 'white';
            });
            
            // Destacar selecionado
            event.currentTarget.style.borderColor = 'var(--primary-purple)';
            event.currentTarget.style.background = 'var(--primary-50)';
            
            // Mostrar próximo step
            setTimeout(() => {
                document.getElementById('step2').style.display = 'block';
                document.getElementById('establishmentName').textContent = name;
                document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // Função chamada quando QR Code é escaneado com sucesso
        function onQRScanned(qrData) {
            console.log('QR Code detectado na página:', qrData);
            scannedQRCode = qrData;
            
            // Mostrar seção de informações do QR
            document.getElementById('waiting-qr').style.display = 'none';
            document.getElementById('qr-checkin-info').style.display = 'block';
            
            // Check-in será processado automaticamente pelo qr-scanner.js
            // Não precisamos mais de validação manual
        }

        // Função para atualizar UI com dados do QR Code
        function updateQRInfo(qrInfo) {
            if (qrInfo.pontos_base) {
                document.getElementById('qr-points').textContent = qrInfo.pontos_base;
            }
            
            if (qrInfo.multiplicador) {
                document.getElementById('qr-multiplier').textContent = qrInfo.multiplicador + 'x';
            }
            
            // Mostrar ofertas se existirem
            if (qrInfo.ofertas && qrInfo.ofertas.length > 0) {
                const offersContainer = document.getElementById('qr-offers');
                offersContainer.innerHTML = `
                    <div style="background: var(--accent-orange); color: white; border-radius: var(--radius-lg); padding: 1rem;">
                        <h5 style="margin-bottom: 1rem;"><i class="fas fa-gift"></i> Ofertas Ativas:</h5>
                        ${qrInfo.ofertas.map(oferta => `
                            <div style="background: rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem;">
                                <strong>${oferta.titulo}</strong>
                                <p style="margin: 0.25rem 0 0; font-size: 0.875rem;">${oferta.descricao}</p>
                                ${oferta.bonus_pontos ? `<span style="background: var(--success-green); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">+${oferta.bonus_pontos} pontos</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                offersContainer.style.display = 'block';
            }
        }

        // Função para resetar a interface após check-in
        function resetCheckinInterface() {
            scannedQRCode = null;
            document.getElementById('qr-checkin-info').style.display = 'none';
            document.getElementById('qr-offers').style.display = 'none';
            document.getElementById('waiting-qr').style.display = 'block';
            
            // Resetar scanner se existir
            if (window.qrScanner) {
                window.qrScanner.resetScanner();
            }
        }

        // Check-in agora é processado automaticamente pelo QR Scanner
        // Esta função é mantida para compatibilidade mas não é mais usada
        async function submitCheckin() {
            if (!scannedQRCode) {
                showError('Por favor, escaneie um QR Code primeiro');
                return;
            }

            console.log('Check-in via QR Code será processado automaticamente');
            // O QR Scanner já processa o check-in automaticamente
            // Esta função agora só serve como fallback
        }

        function showSuccessMessage(checkin) {
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            
            document.getElementById('summaryInfo').innerHTML = `
                <div style="text-align: left;">
                    <div style="margin-bottom: 1rem;">
                        <strong>Estabelecimento:</strong> ${checkin.establishmentName}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Valor da Compra:</strong> ${checkin.value}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Pontos a Receber:</strong> <span style="color: var(--success-green); font-weight: bold;">${checkin.points} pontos</span>
                    </div>
                    <div>
                        <strong>Status:</strong> <span style="color: var(--accent-orange);">Em validação</span>
                    </div>
                </div>
            `;
            
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
        }

        function newCheckin() {
            // Reset form
            selectedEstablishmentId = null;
            selectedEstablishmentName = null;
            uploadedPhoto = null;
            
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            
            document.getElementById('searchEstablishment').value = '';
            document.getElementById('purchaseValue').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoUploadArea').style.display = 'block';
            document.getElementById('pointsCalculation').style.display = 'none';
            
            document.querySelectorAll('.establishment-option > div').forEach(div => {
                div.style.borderColor = 'var(--gray-200)';
                div.style.background = 'white';
            });
            
            document.getElementById('step1').scrollIntoView({ behavior: 'smooth' });
        }

        // Adicionar estilo hover para estabelecimentos
        document.querySelectorAll('.establishment-option > div').forEach(div => {
            div.addEventListener('mouseenter', function() {
                if (this.style.borderColor !== 'var(--primary-purple)') {
                    this.style.borderColor = 'var(--gray-400)';
                }
            });
            
            div.addEventListener('mouseleave', function() {
                if (this.style.borderColor !== 'var(--primary-purple)') {
                    this.style.borderColor = 'var(--gray-200)';
                }
            });
        });
    </script>
</body>
</html>