<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promoções - Tem de Tudo</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #1a1a2e; color: #fff; padding-bottom: 80px; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; text-align: center; }
        .header h1 { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .header p { font-size: 13px; opacity: 0.9; }
        .tabs { display: flex; padding: 16px 20px; gap: 12px; border-bottom: 1px solid rgba(102, 126, 234, 0.1); }
        .tab { flex: 1; padding: 12px; background: #2a2a3e; border: 1px solid rgba(102, 126, 234, 0.1); border-radius: 12px; text-align: center; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: transparent; }
        .section { padding: 20px; }
        .section-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
        .promocoes-grid { display: grid; gap: 16px; }
        .promo-card { background: #2a2a3e; border-radius: 16px; overflow: hidden; border: 1px solid rgba(102, 126, 234, 0.1); }
        .promo-header { background: linear-gradient(135deg, #667eea, #764ba2); padding: 16px; position: relative; }
        .promo-badge { position: absolute; top: 12px; right: 12px; background: rgba(255, 255, 255, 0.3); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .promo-empresa { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .promo-title { font-size: 20px; font-weight: 800; margin-bottom: 8px; }
        .promo-valor { font-size: 16px; opacity: 0.9; }
        .promo-body { padding: 16px; }
        .promo-desc { font-size: 13px; color: #b0b0b0; margin-bottom: 16px; line-height: 1.5; }
        .promo-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.05); }
        .promo-validade { font-size: 12px; color: #888; display: flex; align-items: center; gap: 6px; }
        .promo-btn { background: linear-gradient(135deg, #f39c12, #e67e22); padding: 10px 20px; border-radius: 12px; font-size: 13px; font-weight: 700; border: none; cursor: pointer; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 64px; opacity: 0.2; margin-bottom: 16px; }
        .empty-state p { color: #888; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a2e; border-top: 1px solid rgba(102, 126, 234, 0.1); display: flex; justify-content: space-around; padding: 12px 0 8px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: #888; font-size: 11px; font-weight: 500; }
        .nav-item.active { color: #667eea; }
        .nav-item i { font-size: 20px; }
    </style>
    <link rel="stylesheet" href="/css/vale-bonus-theme.css">
</head>
<body>
    <div class="header">
        <h1> Promoções</h1>
        <p>Ofertas exclusivas para você</p>
    </div>
    <div class="tabs">
        <div class="tab active" data-tab="ativas" onclick="trocarTab('ativas')">Ativas</div>
        <div class="tab" data-tab="proximas" onclick="trocarTab('proximas')">Em Breve</div>
        <div class="tab" data-tab="expiradas" onclick="trocarTab('expiradas')">Expiradas</div>
    </div>
    <div class="section">
        <div class="section-title" id="sectionTitle">Promoções Ativas</div>
        <div class="promocoes-grid" id="promocoesGrid"></div>
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-gift"></i>
            <p>Nenhuma promoção disponível</p>
        </div>
    </div>
    <nav class="bottom-nav">
        <a href="/app-inicio.html" class="nav-item"><i class="fas fa-home"></i><span>Início</span></a>
        <a href="/app-scanner.html" class="nav-item"><i class="fas fa-qrcode"></i><span>Scanner</span></a>
        <a href="/app-meus-pontos.html" class="nav-item"><i class="fas fa-wallet"></i><span>Meus pontos</span></a>
        <a href="/app-empresas.html" class="nav-item"><i class="fas fa-store"></i><span>Empresas</span></a>
        <a href="/app-perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
    </nav>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8001' : 'https://tem-de-tudo.onrender.com';
        let todasPromocoes = [];
        let tabAtual = 'ativas';
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = '/entrar.html'; return; }
            await carregarPromocoes();
        });
        async function carregarPromocoes() {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            let user = null;
            
            if (userStr) {
                try {
                    user = JSON.parse(userStr);
                } catch (e) {
                    console.error('Erro ao parsear user:', e);
                }
            }
            
            // Emails de usuários de teste que podem ter dados fictícios
            const usuariosTeste = ['maria@email.com', 'joao@email.com', 'saborearte@email.com', 'bellanapoli@email.com'];
            const ehUsuarioTeste = user && usuariosTeste.includes(user.email);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/promocoes`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Se a API retornou dados, usar eles
                    todasPromocoes = data.data;
                    filtrarPromocoes();
                } else if (ehUsuarioTeste) {
                    // Apenas usuários de teste recebem dados fictícios
                    console.log('Usuário de teste: usando dados fictícios');
                    todasPromocoes = [
                        { id: 1, empresa: 'Sabor e Arte', titulo: 'R$50 por 50 Pontos', valor: 'Consulte regulamento', descricao: 'Troque seus pontos por créditos em qualquer produto.', validade: '2026-03-31', tipo: 'desconto', status: 'ativa' },
                        { id: 2, empresa: 'Bella Napoli', titulo: '2 por 1 em Pizzas', valor: 'Terças e Quintas', descricao: 'Compre uma pizza grande e leve outra do mesmo tamanho grátis.', validade: '2026-02-28', tipo: 'brinde', status: 'ativa' },
                        { id: 3, empresa: 'Academia FitLife', titulo: '20% OFF Mensalidade', valor: '3 primeiros meses', descricao: 'Desconto especial para novos alunos na matrícula.', validade: '2026-04-30', tipo: 'desconto', status: 'ativa' }
                    ];
                    filtrarPromocoes();
                } else {
                    // Novos usuários: sem promoções (aguardam dados reais do banco)
                    console.log('Novo usuário: aguardando promoções reais');
                    todasPromocoes = [];
                    filtrarPromocoes();
                }
            } catch (error) {
                console.error('Erro ao carregar promoções:', error);
                if (ehUsuarioTeste) {
                    // Fallback para usuários de teste
                    todasPromocoes = [
                        { id: 1, empresa: 'Sabor e Arte', titulo: 'R$50 por 50 Pontos', valor: 'Consulte regulamento', descricao: 'Troque seus pontos por créditos em qualquer produto.', validade: '2026-03-31', tipo: 'desconto', status: 'ativa' },
                        { id: 2, empresa: 'Bella Napoli', titulo: '2 por 1 em Pizzas', valor: 'Terças e Quintas', descricao: 'Compre uma pizza grande e leve outra do mesmo tamanho grátis.', validade: '2026-02-28', tipo: 'brinde', status: 'ativa' }
                    ];
                    filtrarPromocoes();
                } else {
                    // Novos usuários veem empty state
                    todasPromocoes = [];
                    filtrarPromocoes();
                }
            }
        }
        function trocarTab(tab) {
            tabAtual = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            const titulos = { ativas: 'Promoções Ativas', proximas: 'Em Breve', expiradas: 'Promoções Expiradas' };
            document.getElementById('sectionTitle').textContent = titulos[tab];
            filtrarPromocoes();
        }
        function filtrarPromocoes() {
            const hoje = new Date();
            let filtradas = todasPromocoes.filter(p => {
                const validade = new Date(p.validade);
                if (tabAtual === 'ativas') return validade >= hoje && p.status === 'ativa';
                if (tabAtual === 'proximas') return p.status === 'proxima';
                if (tabAtual === 'expiradas') return validade < hoje || p.status === 'expirada';
                return true;
            });
            renderizarPromocoes(filtradas);
        }
        function renderizarPromocoes(promocoes) {
            const grid = document.getElementById('promocoesGrid');
            const empty = document.getElementById('emptyState');
            if (promocoes.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            grid.style.display = 'grid';
            empty.style.display = 'none';
            grid.innerHTML = promocoes.map(p => `
                <div class="promo-card">
                    <div class="promo-header">
                        <div class="promo-badge">${p.tipo === 'desconto' ? ' Desconto' : ' Brinde'}</div>
                        <div class="promo-empresa">${p.empresa}</div>
                        <div class="promo-title">${p.titulo}</div>
                        <div class="promo-valor">${p.valor}</div>
                    </div>
                    <div class="promo-body">
                        <div class="promo-desc">${p.descricao}</div>
                        <div class="promo-footer">
                            <div class="promo-validade"><i class="fas fa-calendar"></i>Até ${new Date(p.validade).toLocaleDateString('pt-BR')}</div>
                            <button class="promo-btn" onclick="usarPromocao(${p.id})">Usar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function usarPromocao(id) {
            alert(`Promoção ${id} ativada! Mostre este código na empresa.`);
        }
    </script>
</body>
</html>

