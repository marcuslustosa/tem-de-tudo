<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì± Dashboard Cliente - Tem de Tudo</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="/css/style-unificado.css?v=3">
</head>
<body>
<!-- Header -->
<div class="header">
<div class="header-content">
<div class="header-left">
<h1>Ol√°, <span id="userName">Cliente</span>!</h1>
<p>Bem-vindo ao Tem de Tudo</p>
</div>
<button class="btn-logout" onclick="logout()">
<i class="fas fa-sign-out-alt"></i>
                Sair
            </button>
</div>
</div>
<div class="main">
<!-- Stats -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-header">
<span class="stat-label">Meus Pontos</span>
<div class="stat-icon">
<i class="fas fa-coins"></i>
</div>
</div>
<div class="stat-value" id="totalPontos">0</div>
<div class="stat-subtitle">Dispon√≠veis para resgatar</div>
</div>
<div class="stat-card">
<div class="stat-header">
<span class="stat-label">Promo√ß√µes</span>
<div class="stat-icon">
<i class="fas fa-tags"></i>
</div>
</div>
<div class="stat-value" id="totalPromocoes">0</div>
<div class="stat-subtitle">Dispon√≠veis agora</div>
</div>
<div class="stat-card">
<div class="stat-header">
<span class="stat-label">Este M√™s</span>
<div class="stat-icon">
<i class="fas fa-chart-line"></i>
</div>
</div>
<div class="stat-value" id="pontosMes">0</div>
<div class="stat-subtitle">Pontos ganhos</div>
</div>
</div>
<!-- QR Code -->
<div class="section">
<div class="qrcode-container">
<h3 class="section-title">Meu QR Code</h3>
<p style="color: #999; font-size: 14px; margin-bottom: 12px;">
                    Apresente este c√≥digo para ganhar pontos
                </p>
<div class="qrcode-box" id="qrcodeBox">
<div class="loading-spinner"></div>
</div>
<button class="btn-qr" onclick="showFullQR()">
<i class="fas fa-expand"></i>
                    Ver em Tela Cheia
                </button>
</div>
</div>
<!-- Promo√ß√µes Dispon√≠veis -->
<div class="section">
<h3 class="section-title">Promo√ß√µes Dispon√≠veis</h3>
<div id="promocoesList">
<div class="loading">
<div class="loading-spinner"></div>
<p>Carregando promo√ß√µes...</p>
</div>
</div>
</div>
<!-- Hist√≥rico de Pontos -->
<div class="section">
<h3 class="section-title">Hist√≥rico Recente</h3>
<div id="historicoList">
<div class="loading">
<div class="loading-spinner"></div>
<p>Carregando hist√≥rico...</p>
</div>
</div>
</div>
</div>
<!-- Bottom Navigation -->
<nav class="bottom-nav">
<a href="/app-inicio.html" class="nav-item active">
<i class="fas fa-home"></i>
<span>In√≠cio</span>
</a>
<a href="/app-empresas.html" class="nav-item">
<i class="fas fa-search"></i>
<span>Buscar</span>
</a>
<a href="/app-meus-pontos.html" class="nav-item">
<i class="fas fa-wallet"></i>
<span>Pontos</span>
</a>
<a href="/app-promocoes.html" class="nav-item">
<i class="fas fa-tags"></i>
<span>Promo√ß√µes</span>
</a>
<a href="/app-perfil.html" class="nav-item">
<i class="fas fa-user"></i>
<span>Perfil</span>
</a>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
        // Configura√ß√£o de API mais robusta
        let API_URL;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            // LOCAL: Tenta v√°rias portas comuns do Laravel
            API_URL = 'http://127.0.0.1:8000/api';
        } else if (window.location.hostname.includes('render.com') || window.location.hostname.includes('herokuapp.com')) {
            // PRODU√á√ÉO: Render, Heroku, etc
            API_URL = '/api';
        } else {
            // OUTROS: Relative path como fallback
            API_URL = '/api';
        }
        
        // Verificar autentica√ß√£o
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');
        
        if (!token || !userStr || userStr === 'undefined' || userStr === 'null') {
            localStorage.clear();
            window.location.href = 'entrar.html';
        }
        
        let user;
        try {
            user = JSON.parse(userStr);
            if (!user || !user.perfil || user.perfil !== 'cliente') {
                localStorage.clear();
                window.location.href = 'entrar.html';
            }
        } catch (e) {
            localStorage.clear();
            window.location.href = 'entrar.html';
        }
        
        // Exibir nome do usu√°rio
        document.getElementById('userName').textContent = user.name || user.email.split('@')[0];
        
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.clear();
                window.location.href = 'entrar.html';
            }
        }
        
        // Gerar QR Code
        function generateQRCode() {
            const qrcodeBox = document.getElementById('qrcodeBox');
            qrcodeBox.innerHTML = '';
            
            new QRCode(qrcodeBox, {
                text: `TDT-USER-${user.id}`,
                width: 180,
                height: 180,
                colorDark: '#1e293b',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        function showFullQR() {
            window.location.href = '/app-qrcode.html';
        }
        
        // Carregar dados
        async function loadData() {
            try {
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                };
                
                // Carregar pontos
                const pontosResponse = await fetch(`${API_URL}/cliente/pontos`, { headers });
                const pontosData = await pontosResponse.json();
                
                if (pontosData.total !== undefined) {
                    document.getElementById('totalPontos').textContent = pontosData.total;
                    document.getElementById('pontosMes').textContent = pontosData.mes || 0;
                }
                
                // Carregar promo√ß√µes
                const promocoesResponse = await fetch(`${API_URL}/promocoes`, { headers });
                const promocoesData = await promocoesResponse.json();
                
                if (promocoesData.promocoes) {
                    renderPromocoes(promocoesData.promocoes);
                    document.getElementById('totalPromocoes').textContent = promocoesData.promocoes.length;
                }
                
                // Carregar hist√≥rico
                const historicoResponse = await fetch(`${API_URL}/cliente/historico`, { headers });
                const historicoData = await historicoResponse.json();
                
                if (historicoData.transacoes) {
                    renderHistorico(historicoData.transacoes);
                }
                
                // Gerar QR Code
                generateQRCode();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                // Dados de fallback para desenvolvimento
                document.getElementById('totalPontos').textContent = '0';
                document.getElementById('totalPromocoes').textContent = '0';
                document.getElementById('pontosMes').textContent = '0';
                renderPromocoes([]);
                renderHistorico([]);
                generateQRCode();
            }
        }
        
        function renderPromocoes(promocoes) {
            const html = promocoes.length > 0 ? promocoes.map(promo => `
                <div class="promo-card">
<div class="promo-header">
<div>
<div class="promo-title">${promo.titulo}</div>
<div class="promo-empresa">${promo.empresa_nome || 'Estabelecimento Parceiro'}</div>
</div>
<div class="promo-badge">
                            ${promo.pontos_necessarios} pts
                        </div>
</div>
<p class="promo-desc">
                        ${promo.descricao || 'Promo√ß√£o exclusiva'}
                    </p>
<button class="btn-resgatar" onclick="resgatarPromocao(${promo.id})">
<i class="fas fa-gift"></i> Resgatar
                    </button>
</div>
            `).join('') : `
                <div class="empty-state">
<i class="fas fa-tags"></i>
<p>Nenhuma promo√ß√£o dispon√≠vel no momento</p>
</div>
            `;
            
            document.getElementById('promocoesList').innerHTML = html;
        }
        
        function renderHistorico(transacoes) {
            const html = transacoes.length > 0 ? transacoes.slice(0, 5).map(t => `
                <div class="historico-item">
<div class="historico-info">
<div class="historico-title">${t.descricao || 'Transa√ß√£o'}</div>
<div class="historico-date">${new Date(t.created_at).toLocaleDateString('pt-BR')}</div>
</div>
<div class="historico-pontos ${t.tipo === 'ganho' ? 'gain' : 'loss'}">
                        ${t.tipo === 'ganho' ? '+' : '-'}${t.pontos}
                    </div>
</div>
            `).join('') : `
                <div class="empty-state">
<i class="fas fa-history"></i>
<p>Nenhuma transa√ß√£o ainda</p>
</div>
            `;
            
            document.getElementById('historicoList').innerHTML = html;
        }
        
        async function resgatarPromocao(id) {
            try {
                const response = await fetch(`${API_URL}/cliente/resgatar-promocao/${id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úÖ Promo√ß√£o resgatada com sucesso!\n\nConfira em "Cupons".');
                    loadData();
                } else {
                    alert('‚ùå ' + (result.message || 'Erro ao resgatar promo√ß√£o'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao conectar com o servidor');
            }
        }
        
        // Carregar dados ao iniciar
        loadData();
    </script>
</body>
</html>

