<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0; url=admin-painel.html">
    <script>window.location.href = 'admin-painel.html';</script>
    <title>Redirecionando...</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <!-- Stylesheets -->
    <script src="/js/config.js"></script>
<link rel="stylesheet" href="/css/vivo-global.css">
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-container">
                <a href="admin-painel.html" class="logo">
                    <i class="fas fa-gem" style="color: #6F1AB6; margin-right: 8px; font-size: 1.2rem;"></i>
                    <span style="font-weight: 800; background: linear-gradient(135deg, #6F1AB6, #9333EA); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Tem de Tudo</span>
                    <span style="margin-left: 8px; font-size: 0.8rem; opacity: 0.7;">ADMIN</span>
                </a>
                <nav class="nav-menu">
                    <a href="admin-painel.html" class="active">
                        <i class="fas fa-home icon-sm"></i> Dashboard
                    </a>
                    <a href="admin-usuarios.html">
                        <i class="fas fa-users icon-sm"></i> Usuários
                    </a>
                    <a href="admin-empresas.html">
                        <i class="fas fa-building icon-sm"></i> Empresas
                    </a>
                    <a href="admin-relatorios.html">
                        <i class="fas fa-chart-bar icon-sm"></i> Relatórios
                    </a>
                    <a href="admin-configuracoes.html">
                        <i class="fas fa-cog icon-sm"></i> Configura??es
                    </a>
                    <a href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt icon-sm"></i> Sair
                    </a>
                </nav>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </header>
        <!-- Mobile Navigation -->
        <div class="mobile-nav" id="mobileNav">
            <div class="mobile-nav-menu">
                <a href="admin-painel.html" class="active">
                    <i class="fas fa-home icon-sm"></i> Dashboard
                </a>
                <a href="admin-usuarios.html">
                    <i class="fas fa-users icon-sm"></i> Usuários
                </a>
                <a href="admin-empresas.html">
                    <i class="fas fa-building icon-sm"></i> Empresas
                </a>
                <a href="admin-relatorios.html">
                    <i class="fas fa-chart-bar icon-sm"></i> Relatórios
                </a>
                <a href="admin-configuracoes.html">
                    <i class="fas fa-cog icon-sm"></i> Configura??es
                </a>
                <a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt icon-sm"></i> Sair
                </a>
            </div>
        </div>
        <!-- Main Content -->
        <main class="app-main">
            <div style="max-width: 1200px; margin: 0 auto; padding: var(--space-6);">
                <!-- Welcome Section -->
                <div class="glass-container" style="margin-bottom: var(--space-8);">
                    <div style="display: flex; align-items: center; gap: var(--space-4);">
                        <div style="background: var(--gradient-primary); width: 64px; height: 64px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-shield-alt" style="font-size: 24px; color: white;"></i>
                        </div>
                        <div>
                            <h1 style="margin: 0; font-size: 1.5rem; color: var(--gray-900);">
                                Painel Administrativo
                            </h1>
                            <p style="margin: 0; color: var(--gray-600);">
                                Bem-vindo(a), <span id="adminName">Administrador</span>
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Stats Grid -->
                <div class="grid grid-cols-4" style="gap: var(--space-6); margin-bottom: var(--space-8);">
                    <div class="stat-card">
                        <i class="fas fa-users" style="font-size: 2rem; color: var(--primary-purple); margin-bottom: var(--space-2);"></i>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total de Usu?rios</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-building" style="font-size: 2rem; color: var(--accent-orange); margin-bottom: var(--space-2);"></i>
                        <div class="stat-value" id="totalEmpresas">0</div>
                        <div class="stat-label">Empresas Ativas</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--accent-green); margin-bottom: var(--space-2);"></i>
                        <div class="stat-value" id="totalPontos">0</div>
                        <div class="stat-label">Pontos Distribu?dos</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--accent-pink); margin-bottom: var(--space-2);"></i>
                        <div class="stat-value" id="alertas">0</div>
                        <div class="stat-label">Alertas do Sistema</div>
                    </div>
                </div>
                <!-- Recent Activity -->
                <div class="card" style="margin-bottom: var(--space-8);">
                    <div class="card-body">
                        <h2 style="margin: 0 0 var(--space-6); color: var(--primary-purple); display: flex; align-items: center; gap: var(--space-2);">
                            <i class="fas fa-clock"></i>
                            Atividade Recente
                        </h2>
                        <div id="recentActivity" style="display: flex; flex-direction: column; gap: var(--space-4);">
                            <!-- Activity items will be loaded here -->
                            <div style="text-align: center; color: var(--gray-500); padding: var(--space-8);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: var(--space-4);"></i>
                                <p>Carregando atividades...</p>
                            </div>
                        </div>
                        <div style="margin-top: var(--space-6); text-align: center;">
                            <a href="admin-relatorios.html" class="btn btn-outline">
                                <i class="fas fa-history"></i>
                                Ver Relat?rio Completo
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Quick Actions -->
                <div class="grid grid-cols-3" style="gap: var(--space-6);">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-user-plus" style="font-size: 3rem; color: var(--primary-purple); margin-bottom: var(--space-4);"></i>
                            <h3 style="margin: 0 0 var(--space-2); color: var(--gray-900);">Criar Usu?rio</h3>
                            <p style="margin: 0 0 var(--space-4); color: var(--gray-600); font-size: 0.875rem;">
                                Adicionar novo usu?rio ao sistema
                            </p>
                            <a href="/admin/usuarios.html?action=create" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i>
                                Criar
                            </a>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-building" style="font-size: 3rem; color: var(--accent-orange); margin-bottom: var(--space-4);"></i>
                            <h3 style="margin: 0 0 var(--space-2); color: var(--gray-900);">Gerenciar Empresas</h3>
                            <p style="margin: 0 0 var(--space-4); color: var(--gray-600); font-size: 0.875rem;">
                                Aprovar e configurar estabelecimentos
                            </p>
                            <a href="admin-empresas.html" class="btn btn-primary btn-sm">
                                <i class="fas fa-cog"></i>
                                Gerenciar
                            </a>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-bar" style="font-size: 3rem; color: var(--accent-green); margin-bottom: var(--space-4);"></i>
                            <h3 style="margin: 0 0 var(--space-2); color: var(--gray-900);">Relat?rios</h3>
                            <p style="margin: 0 0 var(--space-4); color: var(--gray-600); font-size: 0.875rem;">
                                An?lise de dados e estat?sticas
                            </p>
                            <a href="admin-relatorios.html" class="btn btn-primary btn-sm">
                                <i class="fas fa-chart-line"></i>
                                Ver Relat?rios
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Scripts -->
    <script src="/js/global.js"></script>
    <script src="/js/auth-middleware.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // Verificar autentica??o de admin
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar se est? autenticado
            if (!authMiddleware.isAuthenticated()) {
                window.location.href = 'admin-login.html';
                return;
            }
            // Validar token com o servidor
            const tokenValid = await authMiddleware.validateToken();
            if (!tokenValid) {
                return; // J? foi redirecionado pelo validateToken
            }
            // Verificar se tem acesso ? rota
            if (!authMiddleware.hasAccessToCurrentRoute()) {
                authMiddleware.redirectToCorrectRoute();
                return;
            }
            // Verificar se ? admin
            const user = authMiddleware.getCurrentUser();
            if (!user || user.perfil !== 'admin') {
                alert('Acesso negado. Voc? n?o tem permiss?es administrativas.');
                authMiddleware.logout();
                return;
            }
            // Carregar dados do dashboard
            loadDashboardData();
            loadRecentActivity();
        });
        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('token');
                const response = await fetch('/api/admin/dashboard-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('totalUsers').textContent = data.data.total_users || 0;
                        document.getElementById('totalEmpresas').textContent = data.data.total_empresas || 0;
                        document.getElementById('totalPontos').textContent = data.data.total_pontos || 0;
                        document.getElementById('alertas').textContent = data.data.alertas || 0;
                        // Atualizar nome do admin
                        const user = authMiddleware.getCurrentUser();
                        if (user && user.name) {
                            document.getElementById('adminName').textContent = user.name;
                        }
                    }
                } else if (response.status === 401) {
                    // Token inv?lido, fazer logout
                    authMiddleware.logout();
                }
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/admin/recent-activity', {
                    headers: {
                        'Authorization': `Bearer ${window.Auth.getToken()}`,
                        'Accept': 'application/json'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayRecentActivity(data.data);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar atividade recente:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: var(--space-8);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: var(--space-4);"></i>
                        <p>Erro ao carregar atividades recentes</p>
                    </div>
                `;
            }
        }
        function displayRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: var(--space-8);">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: var(--space-4);"></i>
                        <p>Nenhuma atividade recente</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = activities.map(activity => `
                <div style="display: flex; align-items: center; gap: var(--space-4); padding: var(--space-4); background: var(--gray-50); border-radius: var(--radius-lg);">
                    <div style="background: var(--primary-purple); width: 40px; height: 40px; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-${getActivityIcon(activity.type)}" style="color: #1D1D1F;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--gray-900);">
                            ${activity.title}
                        </div>
                        <div style="color: var(--gray-600); font-size: 0.875rem;">
                            ${activity.description}
                        </div>
                    </div>
                    <div style="color: var(--gray-500); font-size: 0.875rem;">
                        ${formatTimeAgo(activity.created_at)}
                    </div>
                </div>
            `).join('');
        }
        function getActivityIcon(type) {
            const icons = {
                'user_registered': 'user-plus',
                'empresa_created': 'building',
                'login': 'sign-in-alt',
                'system': 'cog'
            };
            return icons[type] || 'info-circle';
        }
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            if (diffInMinutes < 1) return 'Agora';
            if (diffInMinutes < 60) return `${diffInMinutes}min atr?s`;
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}h atr?s`;
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays}d atr?s`;
        }
        function logout() {
            if (window.Auth) {
                window.Auth.logout();
            } else {
                localStorage.clear();
                window.location.href = 'admin-login.html';
            }
        }
        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }
    </script>
</body>
</html>