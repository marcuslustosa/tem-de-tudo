<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresas - Tem de Tudo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0a0a0f; color: #fff; padding-bottom: 80px; }
        
        .header { background: #1a1a2e; padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .header h1 { font-size: 22px; font-weight: 800; margin-bottom: 6px; }
        .header p { font-size: 13px; opacity: 0.9; }
        
        .search-section { padding: 16px 20px; background: #0a0a0f; }
        .search-box { position: relative; margin-bottom: 12px; }
        .search-box input { width: 100%; padding: 14px 16px 14px 48px; background: rgba(255,255,255,0.05); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 16px; color: #fff; font-size: 15px; outline: none; }
        .search-box input::placeholder { color: #888; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #667eea; font-size: 18px; }
        
        .filter-section { padding: 0 20px 16px; }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip { background: rgba(255,255,255,0.05); border: 1px solid rgba(102, 126, 234, 0.2); padding: 10px 18px; border-radius: 24px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; }
        .filter-chip.active { background: #f59e0b; border-color: transparent; }
        .filter-chip:active { transform: scale(0.95); }
        
        .section { padding: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 18px; font-weight: 800; }
        .view-toggle { display: flex; gap: 8px; }
        .view-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(102, 126, 234, 0.2); padding: 8px 12px; border-radius: 10px; color: #888; cursor: pointer; transition: all 0.3s; }
        .view-btn.active { background: #f59e0b; color: #fff; border-color: transparent; }
        
        /* GRID */
        .empresas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .empresas-grid .empresa-card { background: rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; text-decoration: none; color: #fff; border: 1px solid rgba(102, 126, 234, 0.1); transition: transform 0.3s; display: block; }
        .empresas-grid .empresa-card:active { transform: scale(0.97); }
        .empresas-grid .empresa-img { width: 100%; height: 120px; object-fit: cover; }
        .empresas-grid .empresa-content { padding: 12px; }
        .empresas-grid .empresa-name { font-size: 14px; font-weight: 700; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .empresas-grid .empresa-category { font-size: 11px; color: #888; margin-bottom: 8px; }
        .empresas-grid .empresa-footer { display: flex; justify-content: space-between; align-items: center; }
        .empresas-grid .empresa-distance { font-size: 11px; color: #667eea; display: flex; align-items: center; gap: 4px; }
        .empresas-grid .empresa-pontos { background: linear-gradient(135deg, #f39c12, #e67e22); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        
        /* LISTA */
        .empresas-list { display: flex; flex-direction: column; gap: 12px; }
        .empresas-list .empresa-card { background: rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; text-decoration: none; color: #fff; border: 1px solid rgba(102, 126, 234, 0.1); transition: transform 0.3s; display: flex; }
        .empresas-list .empresa-card:active { transform: scale(0.98); }
        .empresas-list .empresa-img { width: 100px; height: 100px; object-fit: cover; flex-shrink: 0; }
        .empresas-list .empresa-content { padding: 12px; flex: 1; }
        .empresas-list .empresa-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .empresas-list .empresa-category { font-size: 12px; color: #888; margin-bottom: 10px; }
        .empresas-list .empresa-footer { display: flex; justify-content: space-between; align-items: center; }
        .empresas-list .empresa-distance { font-size: 12px; color: #667eea; display: flex; align-items: center; gap: 4px; }
        .empresas-list .empresa-pontos { background: linear-gradient(135deg, #f39c12, #e67e22); padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 64px; opacity: 0.2; margin-bottom: 16px; }
        .empty-state p { color: #888; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0f; border-top: 1px solid rgba(102, 126, 234, 0.1); display: flex; justify-content: space-around; padding: 12px 0 8px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; text-decoration: none; color: #888; font-size: 11px; font-weight: 500; }
        .nav-item.active { color: #667eea; }
        .nav-item i { font-size: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Empresas</h1>
        <p>Descubra os melhores lugares perto de você</p>
    </div>

    <div class="search-section">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" placeholder="Buscar empresas...">
        </div>
    </div>

    <div class="filter-section">
        <div class="filter-scroll">
            <div class="filter-chip active" data-category="todos">
                <i class="fas fa-globe"></i> Todos
            </div>
            <div class="filter-chip" data-category="alimentacao">
                <i class="fas fa-utensils"></i> Alimentação
            </div>
            <div class="filter-chip" data-category="saude">
                <i class="fas fa-heartbeat"></i> Saúde
            </div>
            <div class="filter-chip" data-category="beleza">
                <i class="fas fa-spa"></i> Beleza
            </div>
            <div class="filter-chip" data-category="servicos">
                <i class="fas fa-wrench"></i> Serviços
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <div class="section-title">Perto de você</div>
            <div class="view-toggle">
                <div class="view-btn active" onclick="setView('grid')">
                    <i class="fas fa-th"></i>
                </div>
                <div class="view-btn" onclick="setView('list')">
                    <i class="fas fa-list"></i>
                </div>
            </div>
        </div>
        <div class="empresas-grid" id="empresasContainer">
            <!-- Cards gerados dinamicamente -->
        </div>
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-search"></i>
            <p>Nenhuma empresa encontrada</p>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="/app-inicio.html" class="nav-item"><i class="fas fa-home"></i><span>Início</span></a>
        <a href="/app-empresas.html" class="nav-item active"><i class="fas fa-search"></i><span>Buscar</span></a>
        <a href="/app-meus-pontos.html" class="nav-item"><i class="fas fa-wallet"></i><span>Pontos</span></a>
        <a href="/app-promocoes.html" class="nav-item"><i class="fas fa-tags"></i><span>Promoções</span></a>
        <a href="/app-perfil.html" class="nav-item"><i class="fas fa-user"></i><span>Perfil</span></a>
    </nav>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8888' : 'https://tem-de-tudo.onrender.com';
        let todasEmpresas = [];
        let categoriaAtual = 'todos';
        let viewMode = 'grid';

        // Função para fazer requisições autenticadas
        async function apiRequest(url, options = {}) {
            const token = localStorage.getItem('token'); // CORRIGIDO
            
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(url, {
                ...options,
                headers: { ...headers, ...(options.headers || {}) }
            });
            
            if (response.status === 401) {
                localStorage.removeItem('token'); // CORRIGIDO
                localStorage.removeItem('user_data');
                window.location.href = '/entrar.html';
                return null;
            }
            
            return response;
        }

        // Carregar empresas da API
        async function loadEmpresas() {
            try {
                // Construir URL com parâmetros
                const urlParams = new URLSearchParams(window.location.search);
                const query = urlParams.get('q') || '';
                const category = urlParams.get('category') || '';
                
                let apiUrl = '/api/empresas?';
                if (query) apiUrl += `search=${encodeURIComponent(query)}&`;
                if (category) apiUrl += `categoria=${encodeURIComponent(category)}&`;
                
                const response = await apiRequest(apiUrl + 'limit=50');
                
                if (response && response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.empresas) {
                        todasEmpresas = data.empresas;
                        
                        // Se veio categoria da URL, ativar filtro
                        if (category) {
                            categoriaAtual = category;
                            const categoryChip = document.querySelector(`.filter-chip[data-category="${category}"]`);
                            if (categoryChip) {
                                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                                categoryChip.classList.add('active');
                            }
                        }
                        
                        // Se veio busca da URL, preencher campo
                        if (query) {
                            document.getElementById('searchInput').value = query;
                        }
                        
                        filtrarEmpresas(query.toLowerCase());
                        return;
                    }
                }
                
                // Se falhar, usar fallback
                loadEmpresasFallback();
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                loadEmpresasFallback();
            }
        }

        // Fallback com empresas mockadas
        function loadEmpresasFallback() {
            const empresasMock = [
                {id: 1, nome: 'Sabor e Arte', descricao: 'Restaurante brasileiro', categoria: 'alimentacao', logo: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400', points_multiplier: 1.5},
                {id: 2, nome: 'Bella Napoli', descricao: 'Pizzaria artesanal', categoria: 'alimentacao', logo: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400', points_multiplier: 2},
                {id: 3, nome: 'FitLife Academia', descricao: 'Academia completa', categoria: 'saude', logo: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=400', points_multiplier: 1},
                {id: 4, nome: 'Beleza Total', descricao: 'Salão de beleza', categoria: 'beleza', logo: 'https://images.unsplash.com/photo-1560066984-138dadb4c035?w=400', points_multiplier: 1.2},
                {id: 5, nome: 'Café & Cia', descricao: 'Cafeteria premium', categoria: 'alimentacao', logo: 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400', points_multiplier: 1.5},
                {id: 6, nome: 'Pet Shop Amigo Fiel', descricao: 'Pet Shop completo', categoria: 'servicos', logo: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=400', points_multiplier: 1},
                {id: 7, nome: 'Farmácia Saúde Plus', descricao: 'Farmácia 24h', categoria: 'saude', logo: 'https://images.unsplash.com/photo-1576602976047-174e57a47881?w=400', points_multiplier: 1.3},
                {id: 8, nome: 'Burger Gourmet', descricao: 'Hamburgueria artesanal', categoria: 'alimentacao', logo: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400', points_multiplier: 2},
                {id: 9, nome: 'Zen Spa', descricao: 'Spa e massagens', categoria: 'beleza', logo: 'https://images.unsplash.com/photo-1540555700478-4be289fbecef?w=400', points_multiplier: 1.5},
                {id: 10, nome: 'Auto Center Premium', descricao: 'Oficina mecânica', categoria: 'servicos', logo: 'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=400', points_multiplier: 1}
            ];
            
            todasEmpresas = empresasMock;
            
            // Aplicar filtros da URL
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q') || '';
            const category = urlParams.get('category') || '';
            
            if (category) {
                categoriaAtual = category;
                const categoryChip = document.querySelector(`.filter-chip[data-category="${category}"]`);
                if (categoryChip) {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    categoryChip.classList.add('active');
                }
            }
            
            if (query) {
                document.getElementById('searchInput').value = query;
            }
            
            filtrarEmpresas(query.toLowerCase());
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadEmpresas();
            
            // Filtros
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    categoriaAtual = chip.dataset.category;
                    filtrarEmpresas();
                    
                    // Atualizar URL
                    const urlParams = new URLSearchParams(window.location.search);
                    if (categoriaAtual === 'todos') {
                        urlParams.delete('category');
                    } else {
                        urlParams.set('category', categoriaAtual);
                    }
                    const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
                    window.history.replaceState({}, '', newUrl);
                });
            });

            // Busca
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filtrarEmpresas(searchTerm);
                
                // Atualizar URL
                const urlParams = new URLSearchParams(window.location.search);
                if (searchTerm.trim()) {
                    urlParams.set('q', searchTerm.trim());
                } else {
                    urlParams.delete('q');
                }
                const newUrl = `${window.location.pathname}${urlParams.toString() ? '?' + urlParams.toString() : ''}`;
                window.history.replaceState({}, '', newUrl);
            });
        });
            });
        });

        function setView(mode) {
            viewMode = mode;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.view-btn').classList.add('active');
            
            const container = document.getElementById('empresasContainer');
            container.className = mode === 'grid' ? 'empresas-grid' : 'empresas-list';
            
            filtrarEmpresas();
        }

        function filtrarEmpresas(searchTerm = '') {
            const container = document.getElementById('empresasContainer');
            const emptyState = document.getElementById('emptyState');
            
            let empresasFiltradas = todasEmpresas;

            // Filtrar por categoria
            if (categoriaAtual !== 'todos') {
                empresasFiltradas = empresasFiltradas.filter(e => 
                    (e.categoria || '').toLowerCase() === categoriaAtual
                );
            }

            // Filtrar por busca
            if (searchTerm) {
                empresasFiltradas = empresasFiltradas.filter(e =>
                    (e.nome || '').toLowerCase().includes(searchTerm) ||
                    (e.descricao || '').toLowerCase().includes(searchTerm)
                );
            }

            if (empresasFiltradas.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = empresasFiltradas.map(e => `
                <a href="/app-empresa-detalhes.html?id=${e.id}" class="empresa-card">
                    <img src="${e.logo || 'https://via.placeholder.com/400x300?text=Sem+Logo'}" 
                         alt="${e.nome}" 
                         class="empresa-img"
                         onerror="this.src='https://via.placeholder.com/400x300?text=Sem+Logo'">
                    <div class="empresa-content">
                        <div class="empresa-name">${e.nome}</div>
                        <div class="empresa-category">${e.descricao || 'Estabelecimento'}</div>
                        <div class="empresa-footer">
                            <div class="empresa-distance">
                                <i class="fas fa-map-marker-alt"></i> ${(Math.random() * 5).toFixed(1)} km
                            </div>
                            <div class="empresa-pontos">
                                ${e.points_multiplier || 1}x pontos
                            </div>
                        </div>
                    </div>
                </a>
            `).join('');
        }
    </script>
</body>
</html>