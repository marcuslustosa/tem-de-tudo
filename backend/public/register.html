<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - TemDeTudo</title>
    <meta name="description" content="Cadastre-se no TemDeTudo e ganhe pontos em suas compras">
    <meta name="theme-color" content="#4c1d95">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">

    <link rel="icon" type="image/png" href="/img/logo.png">
    <link rel="stylesheet" href="/css/modern-theme.css">
</head>
<body style="background: linear-gradient(135deg, #1f2937 0%, #374151 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center;">

    <div class="register-container" style="width: 100%; max-width: 500px; margin: 2rem;">
        <div class="card" style="border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">

            <div class="card-header text-center" style="background: var(--gradient-primary); padding: var(--space-8); position: relative;">
                <!-- Close Button -->
                <button onclick="window.location.href='/index.html'" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-times"></i>
                </button>

                <div style="margin-bottom: 1.5rem;">
                    <img src="/img/logo.png" alt="TemDeTudo" style="width: 64px; height: 64px; border-radius: 50%; border: 3px solid white; display: block; object-fit: cover; background: white;">
                </div>
                <h1 style="color: white; font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem;">Criar conta</h1>
                <p style="color: rgba(255,255,255,0.9); font-size: 0.875rem;">Cadastre-se e ganhe 100 pontos de bônus!</p>
            </div>

            <div class="card-body" style="padding: var(--space-8);">
                <form id="registerForm" onsubmit="handleRegister(event)">

                    <!-- Seleção de Perfil -->
                    <div class="form-group" style="margin-bottom: var(--space-6);">
                        <label for="perfil" class="form-label">
                            <i class="fas fa-user-tag icon-sm"></i> Tipo de conta
                        </label>
                        <select
                            id="perfil"
                            name="perfil"
                            class="form-control"
                            required
                            onchange="toggleRoleFields()"
                        >
                            <option value="">Selecione o tipo de conta</option>
                            <option value="cliente">Cliente - Ganhar pontos em compras</option>
                            <option value="empresa">Empresa - Oferecer pontos aos clientes</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-6);">
                        <label for="name" class="form-label">
                            <i class="fas fa-user icon-sm"></i> Nome completo
                        </label>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            class="form-control"
                            placeholder="Seu nome completo"
                            required
                            autocomplete="name"
                        >
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-6);">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope icon-sm"></i> Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            class="form-control"
                            placeholder="seu@email.com"
                            required
                            autocomplete="username"
                        >
                    </div>

                    <!-- Campos Específicos por Perfil -->
                    <div id="clienteFields" class="role-fields" style="display: none;">
                        <div class="form-group" style="margin-bottom: var(--space-6);">
                            <label for="telefone_cliente" class="form-label">
                                <i class="fas fa-phone icon-sm"></i> Telefone (opcional)
                            </label>
                            <input
                                type="tel"
                                id="telefone_cliente"
                                name="telefone_cliente"
                                class="form-control"
                                placeholder="(11) 99999-9999"
                                autocomplete="tel"
                            >
                        </div>
                    </div>

                    <div id="empresaFields" class="role-fields" style="display: none;">
                        <div class="form-group" style="margin-bottom: var(--space-6);">
                            <label for="cnpj" class="form-label">
                                <i class="fas fa-building icon-sm"></i> CNPJ
                            </label>
                            <input
                                type="text"
                                id="cnpj"
                                name="cnpj"
                                class="form-control"
                                placeholder="00.000.000/0000-00"
                                autocomplete="organization"
                            >
                        </div>

                        <div class="form-group" style="margin-bottom: var(--space-6);">
                            <label for="endereco" class="form-label">
                                <i class="fas fa-map-marker-alt icon-sm"></i> Endereço
                            </label>
                            <input
                                type="text"
                                id="endereco"
                                name="endereco"
                                class="form-control"
                                placeholder="Rua, número, bairro, cidade - UF"
                                autocomplete="address-line1"
                            >
                        </div>

                        <div class="form-group" style="margin-bottom: var(--space-6);">
                            <label for="telefone_empresa" class="form-label">
                                <i class="fas fa-phone icon-sm"></i> Telefone
                            </label>
                            <input
                                type="tel"
                                id="telefone_empresa"
                                name="telefone"
                                class="form-control"
                                placeholder="(11) 99999-9999"
                                autocomplete="tel"
                            >
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-6);">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock icon-sm"></i> Senha
                        </label>
                        <div style="position: relative;">
                            <input
                                type="password"
                                id="password"
                                name="password"
                                class="form-control"
                                placeholder=""
                                required
                                autocomplete="new-password"
                                minlength="8"
                            >
                            <button
                                type="button"
                                onclick="togglePasswordVisibility('password')"
                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-500); cursor: pointer;"
                            >
                                <i id="passwordToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small style="color: var(--gray-600); font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                            Mínimo de 8 caracteres
                        </small>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-6);">
                        <label for="password_confirmation" class="form-label">
                            <i class="fas fa-lock icon-sm"></i> Confirmar senha
                        </label>
                        <div style="position: relative;">
                            <input
                                type="password"
                                id="password_confirmation"
                                name="password_confirmation"
                                class="form-control"
                                placeholder=""
                                required
                                autocomplete="new-password"
                            >
                            <button
                                type="button"
                                onclick="togglePasswordVisibility('password_confirmation')"
                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--gray-500); cursor: pointer;"
                            >
                                <i id="confirmPasswordToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-6);">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; font-size: 0.875rem; color: var(--gray-600); line-height: 1.5;">
                            <input
                                type="checkbox"
                                id="terms"
                                name="terms"
                                required
                                style="margin-right: 12px; margin-top: 4px; flex-shrink: 0; width: 16px; height: 16px;"
                            >
                            <span>
                                Eu concordo com os
                                <a href="/privacidade.html" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    termos de uso e política de privacidade
                                </a>
                            </span>
                        </label>
                    </div>

                    <button
                        type="submit"
                        class="btn btn-primary"
                        id="registerBtn"
                        style="width: 100%; padding: 0.875rem; font-weight: 600; border-radius: var(--border-radius); margin-bottom: var(--space-4);"
                    >
                        <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>
                        Criar conta
                    </button>

                    <div style="text-align: center; margin: var(--space-6) 0;">
                        <span style="color: var(--gray-500); font-size: 0.875rem; background: white; padding: 0 1rem; position: relative;">
                            ou
                        </span>
                        <hr style="border: none; height: 1px; background: var(--gray-200); margin-top: -0.6rem; z-index: -1;">
                    </div>

                    <div style="text-align: center;">
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: var(--space-4);">
                            Já tem uma conta?
                        </p>
                        <a
                            href="/login.html"
                            class="btn btn-outline-primary"
                            style="width: 100%; padding: 0.875rem; font-weight: 600; border-radius: var(--border-radius);"
                        >
                            <i class="fas fa-sign-in-alt" style="margin-right: 0.5rem;"></i>
                            Fazer login
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <div style="text-align: center; margin-top: var(--space-6);">
            <a href="/index.html" style="color: rgba(255,255,255,0.9); text-decoration: none; font-size: 1rem; background: rgba(255,255,255,0.1); padding: 0.75rem 1.5rem; border-radius: var(--radius-full); border: 1px solid rgba(255,255,255,0.2); display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; backdrop-filter: blur(8px);" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar ao início</span>
            </a>
        </div>
    </div>

    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: var(--border-radius); text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
            <p>Criando sua conta...</p>
        </div>
    </div>

    <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

    <script>
        function togglePasswordVisibility(fieldId) {
            const passwordInput = document.getElementById(fieldId);
            const toggleIcon = document.getElementById(fieldId === 'password' ? 'passwordToggleIcon' : 'confirmPasswordToggleIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const registerBtn = document.getElementById('registerBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');

            // Validações básicas no frontend
            const perfil = formData.get('perfil');
            if (!perfil) {
                showMessage('Selecione o tipo de conta', 'error');
                return;
            }

            const password = formData.get('password');
            const passwordConfirmation = formData.get('password_confirmation');

            if (password !== passwordConfirmation) {
                showMessage('As senhas não coincidem', 'error');
                return;
            }

            if (password.length < 8) {
                showMessage('A senha deve ter pelo menos 8 caracteres', 'error');
                return;
            }

            // Validações específicas por perfil
            if (perfil === 'empresa') {
                const cnpj = formData.get('cnpj');
                const endereco = formData.get('endereco');
                const telefone = formData.get('telefone');

                if (!cnpj || !endereco || !telefone) {
                    showMessage('Para empresas, CNPJ, endereço e telefone são obrigatórios', 'error');
                    return;
                }

                // Validar formato CNPJ básico
                const cnpjRegex = /^\d{2}\.\d{3}\.\d{3}\/\d{4}\-\d{2}$/;
                if (!cnpjRegex.test(cnpj)) {
                    showMessage('CNPJ deve estar no formato 00.000.000/0000-00', 'error');
                    return;
                }
            }

            // Mostrar loading
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Criando conta...';
            loadingOverlay.style.display = 'flex';

            try {
                // URL relativa - funciona em qualquer ambiente
                const apiUrl = '/api/auth/register';

                console.log('Tentando cadastro em:', window.location.origin + apiUrl);

                const requestData = {
                    perfil: perfil,
                    name: formData.get('name'),
                    email: formData.get('email'),
                    password: password,
                    password_confirmation: passwordConfirmation,
                    terms: true  // Sempre true se checkbox está marcado (já validado acima)
                };

                // Adicionar campos específicos baseado no perfil
                if (perfil === 'cliente') {
                    requestData.telefone = formData.get('telefone') || null;
                } else if (perfil === 'empresa') {
                    requestData.cnpj = formData.get('cnpj');
                    requestData.endereco = formData.get('endereco');
                    requestData.telefone = formData.get('telefone');
                }

                console.log('Dados enviados:', { ...requestData, password: '[REDACTED]' });

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Status da resposta:', response.status);

                // Sempre tentar parsear JSON, mesmo em erro
                let data;
                const responseText = await response.text();
                console.log('Resposta como texto:', responseText);

                try {
                    data = JSON.parse(responseText);
                    console.log('Dados da resposta JSON:', data);
                } catch (jsonError) {
                    console.error('Erro ao parsear JSON:', jsonError);
                    throw new Error(`Resposta inválida do servidor: ${responseText.substring(0, 200)}`);
                }

                if (response.ok && data.success) {
                    // Sucesso
                    if (data.data && data.data.token) {
                        // Usar os mesmos nomes do login
                        localStorage.setItem('tem_de_tudo_token', data.data.token);
                        localStorage.setItem('tem_de_tudo_user', JSON.stringify(data.data.user));
                        console.log('Token e usuário salvos no localStorage');
                    }

                    showMessage(data.message || 'Conta criada com sucesso!', 'success');

                    // Redirecionar baseado no perfil
                    const redirectUrl = data.data?.redirect_to || (perfil === 'empresa' ? '/dashboard-estabelecimento.html' : '/dashboard-cliente.html');
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 2000);

                } else {
                    // Erro - usar mensagem específica do backend
                    let errorMessage = data.message || 'Erro ao criar conta';

                    if (response.status === 422 && data.errors) {
                        // Erros de validação específicos por campo
                        console.error('Erros de validação:', data.errors);
                        const errorList = [];
                        Object.entries(data.errors).forEach(([field, messages]) => {
                            const fieldName = {
                                'name': 'Nome',
                                'email': 'Email',
                                'password': 'Senha',
                                'password_confirmation': 'Confirmação de Senha',
                                'terms': 'Termos de Uso',
                                'telefone': 'Telefone',
                                'cnpj': 'CNPJ',
                                'endereco': 'Endereço'
                            }[field] || field;
                            const msgs = Array.isArray(messages) ? messages : [messages];
                            errorList.push(`${fieldName}: ${msgs.join(', ')}`);
                        });
                        errorMessage = errorList.join('\n');
                    } else if (response.status === 429) {
                        errorMessage = 'Muitas tentativas. Aguarde alguns minutos.';
                    } else if (response.status === 500) {
                        errorMessage = 'Erro interno do servidor. Tente novamente em alguns instantes.';
                    }

                    console.error('Erro detalhado:', {
                        status: response.status,
                        data: data,
                        fullResponse: JSON.stringify(data, null, 2)
                    });

                    // Se tiver erro_details, mostrar no console
                    if (data.error_details) {
                        console.error('Detalhes do erro do servidor:', data.error_details);
                        alert('ERRO DO BANCO:\n' + JSON.stringify(data.error_details, null, 2));
                    }

                    showMessage(errorMessage, 'error');
                }

            } catch (error) {
                console.error('Erro completo no cadastro:', error);

                let userMessage = 'Erro ao criar conta. Tente novamente.';

                if (error.message.includes('fetch') || error.message.includes('NetworkError')) {
                    userMessage = 'Erro de conexão. Verifique sua internet e tente novamente.';
                } else if (error.message.includes('JSON')) {
                    userMessage = 'Resposta inválida do servidor. Tente novamente.';
                } else if (error.message) {
                    userMessage = error.message;
                }

                showMessage(userMessage, 'error');
            } finally {
                // Sempre restaurar estado do botão
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>Criar conta';
                loadingOverlay.style.display = 'none';
            }
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');

            const bgColor = type === 'success' ? '#22c55e' :
                           type === 'error' ? '#ef4444' : '#3b82f6';

            messageDiv.style.cssText = `
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                margin-bottom: 0.5rem;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;

            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}" style="margin-right: 0.5rem;"></i>
                ${message}
            `;

            container.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Carregar empresas para funcionários
        async function loadEmpresas() {
            try {
                const response = await fetch('/api/empresas');
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('empresa_id');
                    result.data.forEach(empresa => {
                        const option = document.createElement('option');
                        option.value = empresa.id;
                        option.textContent = empresa.nome;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
            }
        }

        // Mostrar/ocultar campos baseado no perfil selecionado e gerenciar required
        function toggleRoleFields() {
            const perfil = document.getElementById('perfil').value;
            const roleFields = document.querySelectorAll('.role-fields');

            // Ocultar todos os campos específicos e remover required
            roleFields.forEach(field => {
                field.style.display = 'none';
                // Remover required de todos os inputs dentro dos campos ocultos
                const inputs = field.querySelectorAll('input[required]');
                inputs.forEach(input => input.removeAttribute('required'));
            });

            // Mostrar campos do perfil selecionado e adicionar required se necessário
            if (perfil) {
                const selectedFields = document.getElementById(perfil + 'Fields');
                if (selectedFields) {
                    selectedFields.style.display = 'block';

                    // Adicionar required apenas aos campos obrigatórios do perfil selecionado
                    if (perfil === 'empresa') {
                        // Para empresa: CNPJ, Endereço e Telefone são obrigatórios
                        document.getElementById('cnpj').setAttribute('required', 'required');
                        document.getElementById('endereco').setAttribute('required', 'required');
                        document.getElementById('telefone_empresa').setAttribute('required', 'required');
                    }
                    // Para cliente: telefone é opcional, então não adiciona required
                }
            }
        }

        // Máscara para CNPJ e telefone - movidos para dentro do DOMContentLoaded

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }

            /* Mobile specific styles */
            @media (max-width: 768px) {
                .register-container {
                    margin: 1rem !important;
                    max-width: none !important;
                }

                .card {
                    border-radius: 1rem !important;
                }

                .card-header {
                    padding: 2rem 1.5rem !important;
                }

                .card-body {
                    padding: 1.5rem !important;
                }

                /* Close button responsive */
                .card-header button {
                    top: 0.75rem !important;
                    right: 0.75rem !important;
                    width: 36px !important;
                    height: 36px !important;
                    font-size: 1rem !important;
                }

                /* Logo responsive */
                .card-header img {
                    width: 56px !important;
                    height: 56px !important;
                }

                /* Title responsive */
                .card-header h1 {
                    font-size: 1.5rem !important;
                }

                /* Form groups spacing */
                .form-group {
                    margin-bottom: 1.25rem !important;
                }

                /* Back button mobile */
                a[href="/index.html"] {
                    padding: 0.875rem 2rem !important;
                    font-size: 1rem !important;
                    margin-top: 1rem !important;
                }
            }
        `;
        document.head.appendChild(style);

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se já está logado
            const token = localStorage.getItem('token');
            if (token) {
                window.location.href = '/dashboard-cliente.html';
            }

            // Call toggleRoleFields to set required attrs based on any pre-selected perfil
            toggleRoleFields();

            // Máscara para CNPJ
            const cnpjInput = document.getElementById('cnpj');
            if (cnpjInput) {
                cnpjInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 14) {
                        value = value.replace(/(\d{2})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1/$2');
                        value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
                        e.target.value = value;
                    }
                });
            }

            // Máscara para telefone
            document.querySelectorAll('input[type="tel"]').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        if (value.length <= 10) {
                            value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                        } else {
                            value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                        }
                        e.target.value = value;
                    }
                });
            });
        });
    </script>
    <script src="/js/global.js"></script>
</body>
</html>
